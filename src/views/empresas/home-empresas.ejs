<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connect Skills</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/shared/style.css">
  <link rel="icon" type="image/png" href="/img/CONNECT.png?v=2">

  <style>
    :root { --header-h: 72px; }
    body { background:#f8f9fb; }
    main#content-main { margin-top: var(--header-h); }
    .rounded-2xl { border-radius: 1rem; }
    .shadow-soft { box-shadow: 0 6px 24px rgba(0,0,0,.06); }
    .pill { display:inline-block; padding:.25rem .6rem; border-radius:999px; background:#f1f3f5; font-size:.85rem; margin:.15rem .25rem .15rem 0; }
    .perfil-logo { width: 64px; height: 64px; object-fit: cover; }
    .card-ghost { border:1px dashed rgba(0,0,0,.15); background:#fff; }
    .card-bl { border:1px solid rgba(0,0,0,.06); }
    .muted { color:#6c757d; }
    .section-title { font-weight:700; font-size:1rem; letter-spacing:.2px; }
    .kpi .num { font-weight:800; font-size:1.25rem; }
  </style>
</head>
<body>
  <%- include('../partials/header-empresa') %>
  <%- include('../partials/flash-messages') %>

  <main id="content-main" class="container py-4 py-md-5">
    <%
      const emp  = (typeof empresa  !== 'undefined' && empresa)  ? empresa  : {};
      const user = (typeof usuario  !== 'undefined' && usuario)  ? usuario  : {};
      const nomeEmpresa = (typeof nome !== 'undefined' && nome) ? nome : (emp.nome_empresa || user.nome || 'Sua empresa');
      const descricaoResolved = (typeof descricao !== 'undefined' && descricao) ? descricao : (emp.descricao || '');
      const localidadeResolved =
        (typeof localidade !== 'undefined' && localidade) ? localidade :
        [emp.cidade, emp.estado, emp.pais].filter(Boolean).join(', ') || 'Localidade nÃ£o informada';
      const fotoResolved =
        (typeof fotoPerfil !== 'undefined' && fotoPerfil) ? fotoPerfil :
        (emp.foto_perfil && emp.foto_perfil.trim() !== '' ? emp.foto_perfil : '/img/avatar.png');

      // --- Progresso do perfil ---
      const hasNome  = !!nomeEmpresa && nomeEmpresa.trim() !== '' && nomeEmpresa !== 'Sua empresa';
      const hasLocal = localidadeResolved && localidadeResolved !== 'Localidade nÃ£o informada';
      const hasTel   = !!(emp.telefone && emp.telefone.trim() !== '');
      const hasFoto  = (
        typeof fotoResolved === 'string' &&
        fotoResolved.trim() !== '' &&
        !['/img/avatar.png', '/img/empresa-padrao.png'].includes(fotoResolved.trim())
      );

      const checklistEmp = [hasNome, hasLocal, hasTel, hasFoto];
      const totalEmp     = checklistEmp.length;
      const doneEmp      = checklistEmp.filter(Boolean).length;
      const profileCompletion = Math.max(0, Math.min(100, Math.round((doneEmp / totalEmp) * 100)));

      // --- Vagas e mÃ©tricas ---
      const _vagasRecentes =
        (typeof vagasRecentes   !== 'undefined' && Array.isArray(vagasRecentes))   ? vagasRecentes   :
        (typeof vagas           !== 'undefined' && Array.isArray(vagas))           ? vagas           :
        (typeof vagasPublicadas !== 'undefined' && Array.isArray(vagasPublicadas)) ? vagasPublicadas :
        [];

      const totalVagasIn = (typeof totais !== 'undefined' && totais && Number.isFinite(totais.totalVagas)) ? Number(totais.totalVagas) : null;
      const totalCandIn  = (typeof totais !== 'undefined' && totais && Number.isFinite(totais.totalCandidatos)) ? Number(totais.totalCandidatos) : null;

      const totalVagas = totalVagasIn !== null ? totalVagasIn : _vagasRecentes.length;
      const totalCandidatos = (function(){
        if (totalCandIn !== null) return totalCandIn;
        return _vagasRecentes.reduce((acc, v) => {
          const tc = Number(v.total_candidatos || v.candidatos_count || 0);
          return acc + (Number.isFinite(tc) ? tc : 0);
        }, 0);
      })();

      const vagasAbertas = (function(){
        const mapStatus = (s) => (String(s || '').toLowerCase());
        let comStatus = 0, total = 0;
        for (const v of _vagasRecentes) {
          total++;
          const s = v.status || v.statusAtual || v.ultimo_status || null;
          if (s == null) continue;
          comStatus++;
          if (mapStatus(s) === 'aberta' || mapStatus(s) === 'abertas') { /* conta em filtro abaixo */ }
        }
        if (comStatus === 0) return _vagasRecentes.length; // fallback
        return _vagasRecentes.filter(v => {
          const s = mapStatus(v.status || v.statusAtual || v.ultimo_status || null);
          return s === 'aberta' || s === 'abertas';
        }).length;
      })();

      const vagasLista = _vagasRecentes.slice(0, 3);

      const tipoMap = { Presencial: 'Presencial', Home_Office: 'Home Office', H_brido: 'HÃ­brido' };
      const moedaSafe = (m) => (m || 'BRL');
      const fmtSalario = (valor, moeda) => {
        if (valor == null || valor === '') return null;
        const n = Number(valor);
        if (!Number.isFinite(n)) return null;
        try { return n.toLocaleString('pt-BR', { style: 'currency', currency: moedaSafe(moeda) }); }
        catch { return `R$ ${n.toFixed(2)}`; }
      };
    %>
    <h2 class="mb-4">Dashboard pessoal</h2>

    <!-- HERO -->
    <div class="bg-white rounded-2xl shadow-soft p-4 p-md-5 mb-4">
      <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
        <div class="d-flex align-items-center gap-3">
          <img
            src="<%= fotoResolved %>"
            alt="Logo da Empresa"
            class="rounded-circle border perfil-logo"
            style="width:64px; height:64px"
            onerror="this.onerror=null;this.src='/img/avatar.png';"
          />
          <div>
            <div class="h4 m-0">OlÃ¡, <%= nomeEmpresa %> ðŸ‘‹</div>
            <div class="small muted">
              <i class="bi bi-geo-alt me-1"></i> <%= localidadeResolved %>
            </div>
            <% if (descricaoResolved) { %>
              <div class="muted"><%= descricaoResolved %></div>
            <% } else { %>
              <div class="muted">Bem-vinda ao seu painel do Connect Skills</div>
            <% } %>
          </div>
        </div>

        <div class="d-flex flex-wrap justify-content-md-end gap-2 mt-3 mt-md-0">
          <a href="/empresa/publicar-vaga" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i> Publicar vaga
          </a>
          <a href="/empresa/meu-perfil" class="btn btn-outline-primary">
            <i class="bi bi-person me-1"></i> Meu perfil
          </a>
        </div>
      </div>
    </div>

    <!-- PROGRESS BAR -->
    <% if (profileCompletion < 100) { %>
      <div class="bg-white rounded-2xl shadow-soft p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="section-title">
            <i class="bi bi-rocket-takeoff me-1"></i>
            Complete o perfil da empresa
          </div>
          <div class="small muted"><%= profileCompletion %>%</div>
        </div>

        <div class="progress">
          <div class="progress-bar bg-primary" data-progress="<%= profileCompletion %>"></div>
        </div>

        <div class="d-flex gap-2 mt-3 flex-wrap">
          <% if (!hasNome)  { %><a href="/empresa/editar-empresa" class="btn btn-sm btn-outline-primary">Definir nome</a><% } %>
          <% if (!hasLocal) { %><a href="/empresa/editar-empresa" class="btn btn-sm btn-outline-primary">Definir localidade</a><% } %>
          <% if (!hasTel)   { %><a href="/empresa/editar-empresa" class="btn btn-sm btn-outline-primary">Adicionar telefone</a><% } %>
          <% if (!hasFoto)  { %><a href="/empresa/editar-empresa" class="btn btn-sm btn-outline-primary">Adicionar logo/foto</a><% } %>
        </div>
      </div>
    <% } %>

    <!-- KPIs -->
    <div class="row g-4 mb-4">
      <div class="col-12 col-lg-4">
        <div class="bg-white rounded-2xl shadow-soft p-4 text-center h-100 kpi">
          <i class="bi bi-briefcase fs-3"></i>
          <div class="num mt-1"><%= totalVagas %></div>
          <div class="muted small">Vagas publicadas</div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="bg-white rounded-2xl shadow-soft p-4 text-center h-100 kpi">
          <i class="bi bi-people fs-3"></i>
          <div class="num mt-1"><%= totalCandidatos %></div>
          <div class="muted small">Candidatos recebidos</div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="bg-white rounded-2xl shadow-soft p-4 text-center h-100 kpi">
          <i class="bi bi-unlock fs-3"></i>
          <div class="num mt-1"><%= vagasAbertas %></div>
          <div class="muted small">Vagas abertas</div>
        </div>
      </div>
    </div>

    <!-- LISTAS -->
    <div class="row g-4 mt-1">
      <div class="col-12 col-lg-7">
        <div class="bg-white rounded-2xl shadow-soft p-4 h-100">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="section-title">
              <i class="bi bi-clock-history me-1"></i>
              Vagas recentes
            </div>
            <a href="/empresa/vagas" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-list-task me-1"></i> Ver todas as vagas
            </a>
          </div>

          <% if (!vagasLista.length) { %>
            <div class="card-ghost p-4 rounded-2xl text-center">
              <div class="muted">VocÃª ainda nÃ£o publicou vagas.</div>
              <a class="btn btn-primary btn-sm mt-2" href="/empresa/publicar-vaga">
                Publicar vaga
              </a>
            </div>
          <% } else { %>
            <% vagasLista.forEach(function (vaga) { %>
              <div class="card-bl bg-white rounded-2xl p-3 p-md-4 mb-3">
                <div class="d-flex gap-3 align-items-start flex-wrap">
                  <img
                    src="<%= fotoResolved %>"
                    alt="Logo da empresa"
                    class="rounded-circle border perfil-logo"
                  >
                  <div class="flex-grow-1">
                    <h5 class="mb-0 fw-bold"><%= nomeEmpresa %></h5>
                    <div class="muted"><%= localidadeResolved %></div>
                    <div class="fw-semibold mt-2"><%= vaga.cargo %></div>
                    <div class="d-flex flex-wrap gap-2 mt-2">
                      <% if (vaga.tipo_local_trabalho) { %>
                        <span class="badge rounded-pill text-bg-light border">
                          <i class="bi bi-geo-alt me-1"></i>
                          <%= tipoMap[vaga.tipo_local_trabalho] || vaga.tipo_local_trabalho %>
                        </span>
                      <% } %>
                      <% if (vaga.salario) { %>
                        <span class="badge rounded-pill text-bg-light border">
                          <i class="bi bi-cash-coin me-1"></i>
                          <%= fmtSalario(vaga.salario, vaga.moeda) %>
                        </span>
                      <% } %>
                      <%
                        const dataCriacao = new Date(vaga.created_at);
                        const dataValida = !isNaN(dataCriacao.getTime());
                      %>
                      <span class="badge rounded-pill text-bg-light border">
                        <i class="bi bi-calendar-event me-1"></i>
                        <%= dataValida ? `Publicado em ${dataCriacao.toLocaleDateString('pt-BR')}` : 'Data nÃ£o disponÃ­vel' %>
                      </span>
                    </div>
                  </div>
                </div>
                <div class="d-flex justify-content-end gap-2 mt-3">
                  <a href="/empresa/vaga/<%= vaga.id %>" class="btn btn-outline-primary">
                    <i class="bi bi-eye me-1"></i> Ver detalhes
                  </a>
                  <a href="/empresa/vaga/<%= vaga?.id %>/editar" class="btn btn-outline-secondary">
                    <i class="bi bi-pencil-square me-1"></i> Editar
                  </a>
                </div>
              </div>
            <% }) %>
          <% } %>
        </div>
      </div>

      <div class="col-12 col-lg-5">
        <div class="bg-white rounded-2xl shadow-soft p-4 h-100">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="section-title">
              <i class="bi bi-people-fill me-1"></i>
              Candidatos por vaga
            </div>
          </div>
          <% if (!vagasLista.length) { %>
            <div class="card-ghost p-4 rounded-2xl text-center">
              <div class="muted">Sem dados ainda â€” publique uma vaga para comeÃ§ar a receber candidatos.</div>
            </div>
          <% } else { %>
            <div class="list-group list-group-flush">
              <% vagasLista.forEach(function (vaga) { %>
                <a href="/empresa/vaga/<%= vaga.id %>" 
                  class="list-group-item list-group-item-action px-0 d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-semibold">
                      <%= vaga.cargo || 'Vaga' %>
                    </div>
                    <div class="small muted">
                      Publicada em:
                      <%= new Date(vaga.created_at || vaga.createdAt || Date.now()).toLocaleDateString('pt-BR') %>
                    </div>
                  </div>
                  <span class="badge rounded-pill text-bg-light border">
                    <i class="bi bi-person-lines-fill me-1"></i>
                    <%= Number(vaga.total_candidatos || vaga.candidatos_count || 0) %>
                  </span>
                </a>
              <% }) %>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <%- include('../partials/contato', { sucesso, erro, candidato: null, empresa: emp }) %>
  </main>

  <%- include('../partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.querySelectorAll('.progress-bar[data-progress]').forEach(el => {
      const v = parseFloat(el.dataset.progress);
      if (!isNaN(v)) el.style.width = v + '%';
    });
  </script>
</body>
</html>
