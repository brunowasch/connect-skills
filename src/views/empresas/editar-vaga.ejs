<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Connect Skills</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/shared/style.css">
  <link rel="icon" type="image/png" href="/img/CONNECT.png?v=2">
</head>
<style>
    :root { --nav-h: 0px !important; }
  body#home { padding-top: 0 !important; }
  .tag-area {
    background-color: #f0f7ff;
    color: #0d6efd;
    border: 1px solid #cfe2ff;
    border-radius: 8px;
    padding: 6px 12px;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    font-weight: 500;
  }
  .btn-remover-tag {
    border: none;
    background: none;
    padding: 0;
    color: #0d6efd;
    cursor: pointer;
    display: flex;
    align-items: center;
  }
  .btn-remover-tag:hover { color: #dc3545; }
</style>
<body 
  data-todas-areas='<%- JSON.stringify(areas || []) %>'
  data-todas-skills='<%- JSON.stringify(skills || []) %>'
  data-selecionadas-areas='<%- JSON.stringify(selectedAreas || []) %>'
  data-selecionadas-skills='<%- JSON.stringify(selectedSkills || []) %>'
>
  <%- include('../partials/header-empresa') %>
  <% const moedaMap = { BRL:'R$', USD:'US$', EUR:'€', GBP:'£', JPY:'¥', ARS:'AR$', CAD:'C$', AUD:'A$', CHF:'CHF', CNY:'¥', INR:'₹', MXN:'MX$', ZAR:'R', KRW:'₩', SEK:'kr', RUB:'₽' }; %>
  <%- include('../partials/flash-messages') %>
  <main class="container py-5 mt-4" style="max-width:800px">
    <a href="/empresa/meu-perfil" class="text-decoration-none" title="Voltar ao perfil">
      <i class="bi bi-x fs-3"></i>
    </a>
    <h2 class="text-center text-primary fw-bold mb-4 mt-4">Editar Vaga</h2>

    <form id="formEditarVaga" action="/empresa/vaga/<%= encId %>/editar" method="POST" enctype="multipart/form-data">
      <div class="row mb-4">
        <div class="col-md-6">
          <label class="form-label">Cargo</label>
          <input type="text" name="cargo" class="form-control" value="<%= vaga.cargo %>" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Tipo de local de trabalho</label>
          <select id="tipo" name="tipo" class="form-select" required>
            <option value="Presencial"   <%= vaga.tipo_local_trabalho==='Presencial'  ? 'selected':'' %>>Presencial</option>
            <option value="Home_Office"  <%= vaga.tipo_local_trabalho==='Home_Office' ? 'selected':'' %>>Home Office</option>
            <option value="H_brido"      <%= vaga.tipo_local_trabalho==='H_brido'     ? 'selected':'' %>>Híbrido</option>
          </select>
        </div>

        <div class="col-md-6 mt-3">
          <label class="form-label">Escala de trabalho</label>
          <input type="text" name="escala" class="form-control" value="<%= vaga.escala_trabalho %>" required>
        </div>

        <div class="col-md-6 mt-3 d-flex align-items-end" id="campo-presencial-hibrido">
          <div id="campoPresencial" class="me-3" style="display:none;">
            <label class="form-label small">Dias presenciais</label>
            <input type="number" id="diasPresenciais" name="diasPresenciais" class="form-control form-control-sm" min="0" max="7" style="width:80px" value="<%= vaga.dias_presenciais || '' %>">
          </div>
          <div id="campoHomeOffice" style="display:none;">
            <label class="form-label small">Dias home office</label>
            <input type="number" id="diasHomeOffice" name="diasHomeOffice" class="form-control form-control-sm" min="0" max="7" style="width:80px" value="<%= vaga.dias_home_office ||'' %>">
          </div>
          <div id="erroDias" class="text-danger small ms-3"></div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6 mt-3">
            <label class="form-label">Salário (opcional)</label>
            <div class="d-flex gap-2">
              <select class="form-select" name="moeda" id="moeda" style="max-width: 90px;">
                <option value="BRL" <%= vaga.moeda === 'BRL' ? 'selected' : '' %>>R$</option>
                <option value="USD" <%= vaga.moeda === 'USD' ? 'selected' : '' %>>US$</option>
                <option value="EUR" <%= vaga.moeda === 'EUR' ? 'selected' : '' %>>€</option>
                <option value="GBP" <%= vaga.moeda === 'GBP' ? 'selected' : '' %>>£</option>
                <option value="JPY" <%= vaga.moeda === 'JPY' ? 'selected' : '' %>>¥</option>
              </select>
              <input type="text" class="form-control" name="salario"
                    value="<%= vaga.salario || '' %>" placeholder="Ex: 2500">
            </div>
          </div>

          <div class="col-md-6 mt-3">
            <label class="form-label">Vínculo empregatício</label>
            <select name="vinculo" class="form-select">
              <option value="">Selecione…</option>
              <option value="Estagio"             <%= vaga.vinculo_empregaticio === 'Estagio' ? 'selected' : '' %>>Estágio</option>
              <option value="CLT_Tempo_Integral"  <%= vaga.vinculo_empregaticio === 'CLT_Tempo_Integral' ? 'selected' : '' %>>CLT (tempo integral)</option>
              <option value="CLT_Meio_Periodo"    <%= vaga.vinculo_empregaticio === 'CLT_Meio_Periodo' ? 'selected' : '' %>>CLT (meio período)</option>
              <option value="Trainee"             <%= vaga.vinculo_empregaticio === 'Trainee' ? 'selected' : '' %>>Trainee</option>
              <option value="Aprendiz"            <%= vaga.vinculo_empregaticio === 'Aprendiz' ? 'selected' : '' %>>Aprendiz</option>
              <option value="PJ"                  <%= vaga.vinculo_empregaticio === 'PJ' ? 'selected' : '' %>>PJ (Pessoa Jurídica)</option>
              <option value="Freelancer_Autonomo" <%= vaga.vinculo_empregaticio === 'Freelancer_Autonomo' ? 'selected' : '' %>>Freelancer / Autônomo</option>
              <option value="Temporario"          <%= vaga.vinculo_empregaticio === 'Temporario' ? 'selected' : '' %>>Temporário</option>
            </select>
          </div>
        </div>

        <div class="col-12 mt-4 mb-4">
          <label class="form-label">Descrição</label>
          <textarea name="descricao" class="form-control" rows="5" required><%= vaga.descricao %></textarea>
        </div>
      </div>

      <div class="mb-4">
        <label class="form-label">Benefícios</label>
        <textarea name="beneficio" class="form-control" rows="2"><%= vaga.beneficio || '' %></textarea>
      </div>

      <div class="mb-4">
        <label class="form-label">Pergunta para a IA</label>
        <textarea name="pergunta" class="form-control" rows="2"><%= vaga.pergunta || '' %></textarea>
      </div>

      <div class="mb-4">
        <label class="form-label">Opções para IA</label>
        <textarea name="opcao" class="form-control" rows="2"><%= vaga.opcao || '' %></textarea>
      </div>
      <div class="mb-4">
        <label class="form-label">Adicionar novos anexos</label>
        <input type="file" name="anexosVaga" multiple class="form-control">
      </div>

      <% if (vaga.vaga_arquivo?.length) { %>
        <h6 class="mt-3">Anexos já enviados</h6>
        <ul class="list-unstyled">
          <% vaga.vaga_arquivo.forEach(ax => { %>
            <li class="d-flex align-items-center justify-content-between border rounded p-2 mb-2">
              <a href="/empresa/public/vaga/anexos/<%= ax.id %>/abrir" target="_blank" rel="noopener">
                <i class="bi bi-paperclip"></i> <%= ax.nome %>
              </a>
              <button class="btn btn-sm btn-outline-danger" formaction="/empresa/vaga/anexos/<%= ax.id %>/delete" formmethod="post">
                <i class="bi bi-trash"></i>
              </button>
            </li>
          <% }) %>
        </ul>
      <% } %>

      <% if (vaga.vaga_link?.length) { %>
        <div class="mb-2">
          <label class="form-label">Links adicionados</label>
          <ul class="list-unstyled">
            <% vaga.vaga_link.forEach(l => { %>
              <li class="mb-2 d-flex align-items-center justify-content-between">
                <a href="<%= l.url %>" target="_blank" rel="noopener">
                  <i class="bi bi-link-45deg me-1"></i> <%= l.titulo %>
                </a>
                <!-- (opcional) botão de excluir -->
                <button class="btn btn-sm btn-outline-danger"
                        formaction="/empresa/vaga/links/<%= l.id %>/delete" formmethod="post">
                  <i class="bi bi-trash"></i>
                </button>
              </li>
            <% }) %>
          </ul>
        </div>
      <% } %>

      <div class="mb-4">
      <label class="form-label">Links úteis da vaga (opcional)</label>

      <div id="links-container">
        <div class="row g-2 align-items-end mb-2 link-row">
          <div class="col-md-5">
            <input type="text" name="linksTitulo[]" class="form-control" placeholder="Ex: Portfólio da empresa">
          </div>
          <div class="col-md-6">
            <input type="url" name="linksUrl[]" class="form-control" placeholder="https://...">
          </div>
          <div class="col-md-1">
            <button type="button" class="btn btn-outline-danger w-100 btn-remover-link">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>

      <button type="button" id="btnAddLink" class="btn btn-outline-secondary btn-sm mt-2">
        <i class="bi bi-plus-lg"></i> Adicionar link
      </button>
    </div>

    <div class="col-12 mt-5">
      <label class="form-label fw-bold">Áreas de Atuação</label>
      
      <div class="position-relative">
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
          <input type="text" id="busca-area" class="form-control" placeholder="Pesquisar nova área...">
        </div>
        <ul id="lista-sugestoes-area" class="list-group position-absolute w-100 shadow-sm d-none" style="z-index: 1000; max-height: 200px; overflow-y: auto;">
          </ul>
      </div>

      <div id="container-tags-areas" class="d-flex flex-wrap gap-2 mt-3">
        </div>

      <input type="hidden" name="areasSelecionadas" id="areas-input">
    </div>

    <div class="mt-3 mb-5">
      <h5 class="fw-bold text-center">Habilidades comportamentais que mais se encaixam à vaga:</h5>
      <div id="skill-container" class="d-flex flex-wrap gap-2 justify-content-center">
        <% skills.forEach(s => { %>
          <% 
            // Compara IDs garantindo que ambos sejam tratados como String
            const isSelected = selectedSkills.some(id => String(id) === String(s.id)); 
          %>
          <button type="button" 
                  class="btn <%= isSelected ? 'btn-primary' : 'btn-outline-primary' %> skill-btn" 
                  data-id="<%= s.id %>">
            <%= s.nome %>
          </button>
        <% }) %>
      </div>
      
      <input type="hidden" name="habilidadesSelecionadas" id="habilidadesSelecionadas" value='<%= JSON.stringify(selectedSkills) %>'>
      <div id="erroHabilidades" class="text-danger small mt-1"></div>
    </div>

      <div class="text-center mt-4">
        <a href="/empresa/meu-perfil" class="btn btn-outline-danger">Cancelar</a>
        <button type="submit" class="btn btn-primary">Salvar alterações</button>
      </div>
    </form>
    <script>
    (function() {
      const container = document.querySelector('#formEditarVaga');
      const inputHidden = document.getElementById('habilidadesSelecionadas');

      function atualizarValorHabilidades() {
        // Captura os IDs dos botões que possuem a classe 'btn-primary'
        const selecionados = Array.from(document.querySelectorAll('.skill-btn.btn-primary'))
                                  .map(b => b.getAttribute('data-id'))
                                  .filter(id => id !== null && id !== "")
                                  .map(id => Number(id)); 
        
        inputHidden.value = JSON.stringify(selecionados);
      }

      container.addEventListener('click', function(e) {
        const btn = e.target.closest('.skill-btn');
        if (btn) {
          btn.classList.toggle('btn-outline-primary');
          btn.classList.toggle('btn-primary');
          atualizarValorHabilidades();
        }
      });

    })();
    </script>
  </main>

  <%- include('../partials/footer') %>
  <div id="serverVals"
     data-pres="<%= vaga.dias_presenciais ?? '' %>"
     data-home="<%= vaga.dias_home_office ?? '' %>"
     data-tipo="<%= vaga.tipo_local_trabalho %>"></div>
  <script src="/js/empresas/publicacaoVagasRequisitos.js"></script>

  <div
  id="areas-data"
  data-todas-areas='<%- JSON.stringify(areas || []) %>'
  data-selecionadas='<%- JSON.stringify(vaga.vaga_area.map(va => va.area_interesse)) %>'>
</div>
<script>
(function() {
  const holder = document.getElementById('areas-data');
  
  const todasAsAreas = JSON.parse(holder?.dataset.todasAreas || '[]');
  let selecionadas = JSON.parse(holder?.dataset.selecionadas || '[]');

  const inputBusca = document.getElementById('busca-area');
  const listaSugestoes = document.getElementById('lista-sugestoes-area');
  const containerTags = document.getElementById('container-tags-areas');
  const hiddenInput = document.getElementById('areas-input');

  // Inicializa a tela com o que já existe
  renderizarTags();

  // 2. BUSCA DINÂMICA
  inputBusca.addEventListener('input', function() {
    const termo = this.value.toLowerCase().trim();
    listaSugestoes.innerHTML = '';

    if (termo.length < 1) {
      listaSugestoes.classList.add('d-none');
      return;
    }

    const filtradas = todasAsAreas.filter(area => 
      area.nome.toLowerCase().includes(termo) && 
      !selecionadas.find(s => s.id === area.id)
    );

    if (filtradas.length > 0) {
      filtradas.forEach(area => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action cursor-pointer';
        li.textContent = area.nome;
        li.style.cursor = 'pointer';
        li.onclick = () => adicionarArea(area);
        listaSugestoes.appendChild(li);
      });
      listaSugestoes.classList.remove('d-none');
    } else {
      listaSugestoes.classList.add('d-none');
    }
  });

  window.adicionarArea = function(area) {
    if (selecionadas.find(s => s.id === area.id)) return;
    selecionadas.push(area);
    inputBusca.value = '';
    listaSugestoes.classList.add('d-none');
    renderizarTags();
  };

  window.removerArea = function(id) {
    selecionadas = selecionadas.filter(a => a.id != id); // Use != para comparar string/number
    renderizarTags();
  };

  function renderizarTags() {
    containerTags.innerHTML = '';
    const ids = selecionadas.map(a => String(a.id));
    
    selecionadas.forEach(area => {
      const tag = document.createElement('div');
      tag.className = 'tag-area'; // Use o CSS que já definimos na publicação
      tag.innerHTML = `
        <span>${area.nome}</span>
        <button type="button" class="btn-remover-tag" onclick="removerArea(${area.id})">
          <i class="bi bi-x-circle-fill"></i>
        </button>
      `;
      containerTags.appendChild(tag);
    });
    hiddenInput.value = JSON.stringify(ids);
  }

  // Fecha sugestões ao clicar fora
  document.addEventListener('click', (e) => {
    if (!inputBusca.contains(e.target)) listaSugestoes.classList.add('d-none');
  });
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const tipo      = document.getElementById('tipo');
  const campoPres = document.getElementById('campoPresencial');
  const campoHome = document.getElementById('campoHomeOffice');
  const ipPres    = document.getElementById('diasPresenciais');
  const ipHome    = document.getElementById('diasHomeOffice');

  const holder = document.getElementById('serverVals');
  const initialTipo  = holder?.dataset.tipo  || 'Presencial';     // 'Presencial' | 'Home_Office' | 'H_brido'
  const initialPres  = holder?.dataset.pres  || '';                // "5", "", etc.
  const initialHome  = holder?.dataset.home  || '';

  // garante que o select tenha o valor normalizado vindo do servidor
  if (tipo && !tipo.value) tipo.value = initialTipo;

  function toggle() {
    const v = tipo?.value || 'Presencial';
    if (campoPres) campoPres.style.display = (v === 'Presencial' || v === 'H_brido')  ? '' : 'none';
    if (campoHome) campoHome.style.display = (v === 'Home_Office' || v === 'H_brido') ? '' : 'none';
  }

  // reatribui valores vindos do servidor se estiverem vazios
  if (ipPres && ipPres.value === '' && initialPres !== '') ipPres.value = initialPres;
  if (ipHome && ipHome.value === '' && initialHome !== '') ipHome.value = initialHome;

  toggle();
  if (tipo) tipo.addEventListener('change', toggle);

  const inputSalario = document.querySelector('input[name="salario"]');
  inputSalario.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    value = (value / 100).toFixed(2) + '';
    value = value.replace(".", ",");
    value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
    e.target.value = value;
  });
});
</script>
<script>
  (function(){
    const wrap = document.getElementById('links-container');
    document.getElementById('btnAddLink').addEventListener('click', () => {
      const row = document.createElement('div');
      row.className = 'row g-2 align-items-end mb-2 link-row';
      row.innerHTML = `
        <div class="col-md-5">
          <input type="text" name="linksTitulo[]" class="form-control" placeholder="Ex: Portfólio da empresa">
        </div>
        <div class="col-md-6">
          <input type="url" name="linksUrl[]" class="form-control" placeholder="https://...">
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-outline-danger w-100 btn-remover-link">
            <i class="bi bi-trash"></i>
          </button>
        </div>`;
      wrap.appendChild(row);
    });
    wrap.addEventListener('click', e => {
      if (e.target.closest('.btn-remover-link')) {
        const row = e.target.closest('.link-row');
        if (row) row.remove();
      }
    });
  })();
</script>
</body>
</html>
