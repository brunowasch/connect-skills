<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connect Skills</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/shared/style.css">
  <link rel="icon" type="image/png" href="/img/CONNECT.png?v=2">
<style>
    :root { --nav-h: 0px !important; }
    body#home { padding-top: 0 !important; }
    .avatar-col { width: 72px; }
    .btn-ver-perfil { font-size: .8rem; padding: .15rem .4rem; line-height: 1.1; }
    .cand-row { transition: background-color 0.2s; }
    .cand-row:hover { background-color: #f8f9fa; }
  </style>
</head>
<body class="bg-light">
  <%- include('../partials/header-empresa') %>
  <%- include('../partials/flash-messages') %>

  <main class="container py-5 mt-4">
    <div class="d-flex align-items-center gap-3 mb-4">
      <a href="/empresa/vagas" class="text-decoration-none" title="Voltar">
        <i class="bi bi-arrow-left fs-4"></i>
      </a>
      <div>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <h3 class="mb-0">Ranqueamento de candidatos</h3>
          <span class="badge rounded-pill border text-primary bg-primary-subtle d-inline-flex align-items-center px-3 py-2">
            <i class="bi bi-people me-2"></i><%= rows.length %> candidatos encontrados
          </span>
        </div>
        <div class="text-muted mt-1">
          Cargo: <strong><%= vaga.cargo %></strong> · Empresa: <strong><%= vaga.empresa?.nome_empresa %></strong>
        </div>
        <div class="text-muted small">
          Os candidatos estão ranqueados com base na compatibilidade (0–100) calculada pela nossa IA a partir das respostas. Em caso de empate, são ranqueados em ordem de chegada.
        </div>
      </div>

      <!-- (novo) seletor de ordenação -->
      <div class="ms-auto d-flex align-items-center gap-2">
        <label for="ordenarPor" class="form-label mb-0">Ordenar por</label>
        <select id="ordenarPor" class="form-select form-select-sm" style="width:auto">
          <option value="score">Score Geral</option>
          <option value="score_D">Dominância (D)</option>
          <option value="score_I">Influência (I)</option>
          <option value="score_S">Estabilidade (S)</option>
          <option value="score_C">Conformidade (C)</option>
        </select>
      </div>
      <!-- /seletor -->
    </div>

    <% if (!rows.length) { %>
      <div class="alert alert-light d-flex align-items-center gap-2">
        <i class="bi bi-info-circle"></i>
        <span>Nenhum candidato aplicou para esta vaga.</span>
      </div>
    <% } else { %>

    <!-- (alterado) id fixo para orientar o JS -->
    <div id="ranking-list" class="bg-white rounded shadow-sm">
      <% rows.forEach((r, idx) => { 
          const modalId = `modal-respostas-${r.candidato_id || idx}`;
          const modalIaId = `modal-ia-${r.candidato_id || idx}`; // (novo)
          const cid = r.candidato_id || r.candidatoId || r.id_candidato || r.id || null;

          const fonte = String(r.questions || '').trim();
          const linhasFonte = (fonte ? fonte : String(vaga.pergunta || ''))
            .split(/\r?\n/)
            .map(s => s.trim())
            .filter(Boolean);

          // NOVO SPLIT: usa a ÚLTIMA interrogação como divisor pergunta/resposta
          const pares = linhasFonte.map((L) => {
            const s = String(L || '').trim();
            if (!s) return { pergunta: '', resposta: '' };
            const lastQ = s.lastIndexOf('?');
            if (lastQ !== -1) {
              const pergunta = s.slice(0, lastQ + 1).trim();
              const resposta = s.slice(lastQ + 1).trim();
              return { pergunta, resposta };
            }
            // Fallbacks com separadores comuns ( " - ", " — ", ":" )
            const m = s.match(/^(.*?)(?:\s[-–—:]\s)(.+)$/);
            if (m) return { pergunta: m[1].trim(), resposta: m[2].trim() };
            // Sem separador -> tudo é pergunta
            return { pergunta: s, resposta: '' };
          });

          const perguntas = pares.map(p => p.pergunta);
          const respostas = pares.map(p => p.resposta);
      %>
        <!-- (alterado) adicionados data-* e classe cand-row para ordenar/filtrar -->
        <div class="p-3 border-bottom d-flex align-items-center justify-content-between cand-row"
             data-score="<%= Number(r.score)||0 %>"
             data-d="<%= Number(r.score_D)||0 %>"
             data-i="<%= Number(r.score_I)||0 %>"
             data-s="<%= Number(r.score_S)||0 %>"
             data-c="<%= Number(r.score_C)||0 %>">

          <div class="fs-5 fw-bold" style="width: 2.5rem; text-align: right;">
            <%= r.pos %>º
          </div>

          <div class="d-flex align-items-center gap-3 flex-grow-1">
            <div class="avatar-col d-flex flex-column align-items-center">
              <% if (cid) { %>
                <a href="/candidatos/perfil/<%= cid %>" target="_blank" rel="noopener" title="Abrir perfil público">
                  <img src="<%= r.foto_perfil || '/img/avatar.png' %>"
                       alt="Foto do candidato"
                       class="rounded-circle"
                       style="width: 48px; height: 48px; object-fit: cover; cursor: pointer;">
                </a>
                <a href="/candidatos/perfil/<%= cid %>" target="_blank" rel="noopener"
                   class="btn btn-outline-primary btn-sm btn-ver-perfil mt-2 w-100">
                  <i class="bi bi-box-arrow-up-right"></i>
                </a>
              <% } else { %>
                <img src="<%= r.foto_perfil || '/img/avatar.png' %>"
                     alt="Foto do candidato (ID ausente)"
                     class="rounded-circle"
                     style="width: 48px; height: 48px; object-fit: cover;">
              <% } %>
            </div>

            <div>
              <div class="fw-semibold"><%= r.nome %></div>
              <div class="text-muted small"><%= r.local %></div>

              <div class="d-flex flex-wrap gap-3 small mt-1">
                <% 
                  const telBruto = String(r.telefone || '');
                  const telLimpo = telBruto.replace(/\+?undefined-?/gi, '').trim();
                %>
                <% if (telLimpo) { %>
                  <a href="tel:<%= telLimpo.replace(/\D/g,'') %>" class="text-decoration-none">
                    <i class="bi bi-telephone"></i> <%= telLimpo %>
                  </a>
                <% } %>
                <% if (r.email) { %>
                  <a href="mailto:<%= r.email %>" class="text-decoration-none">
                    <i class="bi bi-envelope"></i> <%= r.email %>
                  </a>
                <% } %>
                <button type="button"
                        class="btn btn-outline-primary btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#<%= modalId %>">
                  Ver respostas
                </button>
                <div class="d-flex flex-wrap gap-3 small mt-1">
                  
                <% if (r.email) { %>
                  <button type="button" class="btn btn-outline-primary btn-sm" 
                          onclick="prepararSolicitacao('<%= vaga.id %>', '<%= r.email %>', '<%= r.nome %>', '<%= vaga.cargo %>')">
                    <i class="bi bi-camera-video"></i> Solicitar Vídeo
                  </button>
                <% } %>

                <% if (r.temVideo) { %>
                  <button type="button" class="btn btn-primary btn-sm" onclick="abrirVideoCandidato('<%= vaga.id %>', '<%= cid %>')">
                    <i class="bi bi-play-circle"></i> Assistir Vídeo
                  </button>
                <% } %>
                  
                </div>

                <script>
                  function abrirVideoCandidato(vagaId, candidatoId) {
                    
                    // IMPORTANTE: Substitua 'SEU_CLOUD_NAME' pelo seu nome do Cloudinary (ex: dffxxyz)
                    const cloudName = 'dmjzmau2b'; 
                    const publicId = `video_${vagaId}_${candidatoId}`;
                    const videoUrl = `https://res.cloudinary.com/${cloudName}/video/upload/vagas_videos/${publicId}.mp4`;

                    // Tentamos abrir o vídeo em uma nova aba
                    // Se o vídeo não existir, o Cloudinary retornará 404
                    window.open(videoUrl, '_blank');
                }
                </script>

                <!-- (novo) botão Análise geral da IA -->
                <% if (r.explanation || typeof r.score_D !== 'undefined') { %>
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#<%= modalIaId %>">
                    Análise geral da IA
                  </button>
                <% } %>
              </div>
            </div>
          </div>

          <!-- (alterado) bloco do score com classes JS para atualizar % e barra -->
          <div class="text-end" style="min-width: 190px;">
            <div class="fw-semibold">
              <span class="js-metric-value"><%= Number(r.score)||0 %></span>%
            </div>
            <div class="progress" style="height: 8px; width: 180px;">
              <div class="progress-bar js-metric-bar" role="progressbar"
                   data-score="<%= Number(r.score)||0 %>"
                   data-d="<%= Number(r.score_D)||0 %>"
                   data-i="<%= Number(r.score_I)||0 %>"
                   data-s="<%= Number(r.score_S)||0 %>"
                   data-c="<%= Number(r.score_C)||0 %>"
                   aria-valuenow="<%= Number(r.score)||0 %>"
                   aria-valuemin="0" aria-valuemax="100"
                   style="width:<%= Number(r.score)||0 %>%"></div>
            </div>
          </div>
        </div>
        
        <!-- Modal: Ver respostas (mantido) -->
        <div class="modal fade" id="<%= modalId %>" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <div>
                  <h5 class="modal-title">Respostas do candidato</h5>
                  <div class="text-muted small">
                    <strong><%= r.nome %></strong> · Compatibilidade: <strong><%= r.score %>%</strong>
                  </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
              </div>

              <div class="modal-body">
                <% if (perguntas.length) { %>
                  <div class="mb-4">
                    <div class="alert alert-secondary py-1 px-2 mb-3 small">
                      <strong>Questionário da vaga</strong>
                    </div>

                    <% perguntas.forEach((q, i) => { %>
                      <div class="mb-3">
                        <label class="form-label"><%= (i + 1) + '. ' + q %></label>
                        <input type="text"
                               class="form-control"
                               value="<%= (respostas[i] || '') %>"
                               placeholder="<%= respostas[i] ? '' : 'Sem resposta' %>"
                               readonly>
                      </div>
                    <% }) %>
                  </div>
                <% } %>

                <%
                  const temAlguma = pares.some(p => p.pergunta || p.resposta);
                %>
                <% if (temAlguma) { %>
                  <div class="mb-2 fw-semibold">Perguntas e respostas (texto):</div>
                  <ol class="list-group list-group-numbered">
                    <% pares.forEach(p => { %>
                      <li class="list-group-item">
                        <div class="fw-semibold"><%= p.pergunta || 'Pergunta' %></div>
                        <div class="text-muted"><%= p.resposta || '—' %></div>
                      </li>
                    <% }) %>
                  </ol>
                <% } else { %>
                  <div class="alert alert-light mb-0">
                    Nenhuma resposta registrada para este candidato.
                  </div>
                <% } %>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
              </div>
            </div>
          </div>
        </div>

        <!-- (novo) Modal: Análise geral da IA -->
        <% if (r.explanation || typeof r.score_D !== 'undefined') { %>
          <div class="modal fade" id="<%= modalIaId %>" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
              <div class="modal-content">
                <div class="modal-header">
                  <div>
                    <h5 class="modal-title">Análise geral da IA</h5>
                    <div class="text-muted small"><strong><%= r.nome %></strong></div>
                  </div>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>

                <div class="modal-body">
                   <% if (typeof r.score_D !== 'undefined') { %>
                      <div class="mb-3">
                        <div class="small text-muted mb-1">Score geral do candidato</div>

                        <!-- Score geral -->
                        <% if (typeof r.score !== 'undefined') { %>
                          <div class="d-flex justify-content-between small mb-2">
                            <span><strong>Score Geral</strong></span>
                            <span><strong><%= Number(r.score) || 0 %>%</strong></span>
                          </div>
                          <div class="progress mb-3" style="height: 6px;">
                            <div class="progress-bar" role="progressbar"
                                style="width:<%= Number(r.score) || 0 %>%"
                                aria-valuenow="<%= Number(r.score) || 0 %>"
                                aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                        <% } %>
                      <div class="small text-muted mb-1">Perfil DISC</div>
                      <% const _discPairs = [
                           {k:'Dominância (D)', v:Number(r.score_D)||0},
                           {k:'Influência (I)', v:Number(r.score_I)||0},
                           {k:'Estabilidade (S)', v:Number(r.score_S)||0},
                           {k:'Conformidade (C)', v:Number(r.score_C)||0},
                         ]; %>
                      <% _discPairs.forEach(p => { %>
                        <div class="d-flex justify-content-between small">
                          <span><%= p.k %></span><span><strong><%= p.v %>%</strong></span>
                        </div>
                        <div class="progress mb-2" style="height: 6px;">
                          <div class="progress-bar" role="progressbar" style="width:<%= p.v %>%"
                               aria-valuenow="<%= p.v %>" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                      <% }) %>
                    </div>
                  <% } %>

                  <% if (Array.isArray(r.matchedSkills) && r.matchedSkills.length) { %>
                    <div class="mb-3">
                      <div class="small text-muted mb-1">Habilidades compatíveis</div>
                      <div class="d-flex flex-wrap gap-2">
                        <% r.matchedSkills.forEach(s => { %>
                          <span class="badge text-bg-secondary"><%= s %></span>
                        <% }) %>
                      </div>
                    </div>
                  <% } %>

                  <% if (r.explanation) { %>
                    <div class="mb-3">
                      <div class="small text-muted mb-1">Comentário da IA</div>
                      <p class="mb-0"><%= r.explanation %></p>
                    </div>
                  <% } %>

                  <% if (Array.isArray(r.suggestions) && r.suggestions.length) { %>
                    <div class="mb-2">
                      <div class="small text-muted mb-1">Sugestões</div>
                      <ul class="mb-0">
                        <% r.suggestions.forEach(sg => { %>
                          <li><%= sg %></li>
                        <% }) %>
                      </ul>
                    </div>
                  <% } %>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
              </div>
            </div>
          </div>
        <% } %>

      <% }) %>

      <script>
          async function enviarPedidoVideo(email, nomeCand, cargoVaga, vagaId) {
              if(!confirm(`Deseja enviar um e-mail para ${nomeCand} solicitando o vídeo?`)) return;

              try {
                  const response = await fetch('/solicitar-video', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ 
                          emailCandidato: email, 
                          nomeCandidato: nomeCand, 
                          nomeVaga: cargoVaga, 
                          idVaga: vagaId 
                      })
                  });
                  
                  const data = await response.json();
                  if (data.success) {
                      alert('E-mail enviado com sucesso!');
                  } else {
                      alert('Erro ao enviar: ' + data.message);
                  }
              } catch (err) {
                  alert('Erro na conexão com o servidor.');
              }
          }
          </script>
    </div>

    <% } %>
  </main>

  <div class="modal fade" id="modalSolicitarVideo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-envelope-paper me-2"></i>Enviar Solicitação</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center py-4">
          <div class="mb-3">
            <i class="bi bi-camera-reels text-primary" style="font-size: 3rem;"></i>
          </div>
          <p class="mb-1">Você deseja solicitar um vídeo de apresentação para:</p>
          <h4 id="modalNomeCandidato" class="text-dark fw-bold"></h4>
          <p class="text-muted small px-3">O candidato receberá um e-mail profissional com instruções e o link seguro para realizar o upload.</p>
        </div>
        <div class="modal-footer border-0 justify-content-center pb-4">
          <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Agora não</button>
          <button type="button" id="btnConfirmarSolicitacao" class="btn btn-primary px-4 fw-bold">
            <span id="btnSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
            Sim, enviar e-mail
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const modalElement = document.getElementById('modalSolicitarVideo');
      const bsModal = new bootstrap.Modal(modalElement);
      let dadosParaEnvio = null;

      window.prepararSolicitacao = function(idVaga, email, nomeCandidato, nomeVaga) {
        dadosParaEnvio = { idVaga, emailCandidato: email, nomeCandidato, nomeVaga };
        document.getElementById('modalNomeCandidato').textContent = nomeCandidato;
        bsModal.show();
      };

      document.getElementById('btnConfirmarSolicitacao').addEventListener('click', async function() {
        const btn = this;
        const spinner = document.getElementById('btnSpinner');
        btn.disabled = true;
        spinner.classList.remove('d-none');

        try {
          const response = await fetch('/solicitar-video', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dadosParaEnvio)
          });
          const result = await response.json();
          if (result.success) {
            bsModal.hide();
            Swal.fire({ icon: 'success', title: 'Enviado!', text: 'Solicitação enviada com sucesso.', confirmButtonColor: '#0d6efd' });
          } else { throw new Error(result.message); }
        } catch (error) {
          Swal.fire('Erro', 'Não foi possível enviar o e-mail: ' + error.message, 'error');
        } finally {
          btn.disabled = false;
          spinner.classList.add('d-none');
        }
      });

      // Lógica de Ordenação
      const select = document.getElementById('ordenarPor');
      const container = document.getElementById('ranking-list');
      if (select && container) {
        function getRows() { return Array.from(container.querySelectorAll('.cand-row')); }
        function sortBy(key) {
          const rows = getRows();
          rows.sort((a, b) => Number(b.dataset[key.replace('score_','').toLowerCase()] || b.dataset.score) - Number(a.dataset[key.replace('score_','').toLowerCase()] || a.dataset.score));
          rows.forEach(r => {
            const val = r.dataset[key === 'score' ? 'score' : key.replace('score_','').toLowerCase()];
            r.querySelector('.js-metric-bar').style.width = val + '%';
            r.querySelector('.js-metric-value').textContent = val;
            container.appendChild(r);
          });
        }
        select.addEventListener('change', (e) => sortBy(e.target.value));
        sortBy('score');
      }
    });

    function abrirVideoCandidato(vagaId, candidatoId) {
      const cloudName = 'dmjzmau2b'; 
      const videoUrl = `https://res.cloudinary.com/${cloudName}/video/upload/vagas_videos/video_${vagaId}_${candidatoId}.mp4`;
      window.open(videoUrl, '_blank');
    }
  </script>
  
  <script>
    // largura inicial das barras (compatível com o markup original)
    document.querySelectorAll('.progress-bar').forEach(el => {
      const val = Number(el.getAttribute('aria-valuenow') || el.dataset.score || 0);
      el.style.width = val + '%';
    });

    // Ordenação + atualização dinâmica do número/barra com base na métrica escolhida
    (function() {
      const select = document.getElementById('ordenarPor');
      const container = document.getElementById('ranking-list');
      if (!select || !container) return;

      function getRows() {
        return Array.from(container.querySelectorAll('.cand-row'));
      }

      function updatePositions() {
        const rows = getRows();
        rows.forEach((row, idx) => {
          const posEl = row.querySelector('.fs-5.fw-bold');
          if (posEl) posEl.textContent = (idx + 1) + 'º';
        });
      }

      function valueFromRow(row, key) {
        switch (key) {
          case 'score_D': return Number(row.dataset.d || 0);
          case 'score_I': return Number(row.dataset.i || 0);
          case 'score_S': return Number(row.dataset.s || 0);
          case 'score_C': return Number(row.dataset.c || 0);
          default:        return Number(row.dataset.score || 0); // Geral
        }
      }

      function sortBy(key) {
        const rows = getRows();

        // Ordena desc pela métrica selecionada
        rows.sort((a, b) => valueFromRow(b, key) - valueFromRow(a, key));

        // Reanexa na nova ordem e atualiza número/barra exibidos
        rows.forEach(r => {
          const val = valueFromRow(r, key);
          const bar = r.querySelector('.js-metric-bar');
          const num = r.querySelector('.js-metric-value');
          if (bar) {
            bar.style.width = val + '%';
            bar.setAttribute('aria-valuenow', String(val));
          }
          if (num) num.textContent = String(val);
          container.appendChild(r);
        });

        updatePositions();
      }

      // aplica já a métrica atual (Geral por padrão)
      sortBy(select.value || 'score');

      // reordena ao trocar
      select.addEventListener('change', (e) => sortBy(e.target.value));
    })();
  </script>

  <%- include('../partials/footer') %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>