<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ranking de Candidatos | Connect Skills</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/shared/style.css">
  <link rel="icon" type="image/png" href="/img/CONNECT.png?v=2">
  <style>
    :root { --nav-h: 0px !important; }
    body#home { padding-top: 0 !important; }
    .avatar-col { width: 72px; }
    .btn-ver-perfil { font-size: .8rem; padding: .15rem .4rem; line-height: 1.1; }
    .cand-row { transition: background-color 0.2s; }
    .cand-row:hover { background-color: #f8f9fa; }
    /* Estilo para garantir que os botões fiquem alinhados */
    .actions-gap { gap: 0.5rem; }
  </style>
</head>
<body class="bg-light">
  <%- include('../partials/header-empresa') %>
  <%- include('../partials/flash-messages') %>

  <main class="container py-5 mt-4">
    <div class="d-flex align-items-center gap-3 mb-4">
      <a href="/empresas/vagas" class="text-decoration-none" title="Voltar para Vagas">
        <i class="bi bi-arrow-left fs-4"></i>
      </a>
      <div>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <h3 class="mb-0">Ranqueamento de candidatos</h3>
          <span class="badge rounded-pill border text-primary bg-primary-subtle d-inline-flex align-items-center px-3 py-2">
            <i class="bi bi-people me-2"></i><%= rows.length %> candidatos
          </span>
        </div>
        <div class="text-muted mt-1">
          Cargo: <strong><%= vaga.cargo %></strong> · Empresa: <strong><%= vaga.empresa?.nome_empresa %></strong>
        </div>
        <div class="text-muted small">
          Ordenação baseada na compatibilidade IA. Empates seguem a ordem de chegada.
        </div>
      </div>

      <div class="ms-auto d-flex align-items-center gap-2">
        <label for="ordenarPor" class="form-label mb-0 fw-bold text-secondary">Ordenar por:</label>
        <select id="ordenarPor" class="form-select form-select-sm border-secondary" style="width:auto">
          <option value="score">Score Geral</option>
          <option value="score_D">Dominância (D)</option>
          <option value="score_I">Influência (I)</option>
          <option value="score_S">Estabilidade (S)</option>
          <option value="score_C">Conformidade (C)</option>
        </select>
      </div>
    </div>

    <% if (!rows.length) { %>
      <div class="alert alert-light border d-flex align-items-center gap-2 py-4 justify-content-center text-muted">
        <i class="bi bi-info-circle fs-4"></i>
        <span>Nenhum candidato aplicou para esta vaga ainda.</span>
      </div>
    <% } else { %>

    <div id="ranking-list" class="bg-white rounded shadow-sm">
      <% rows.forEach((r, idx) => { 
          const modalId = `modal-respostas-${r.candidato_id || idx}`;
          const modalIaId = `modal-ia-${r.candidato_id || idx}`;
          // Normaliza IDs para garantir funcionamento
          const cid = r.candidato_id || r.candidatoId || r.id_candidato || r.id || null;
          
          // Lógica de parser de perguntas (mantida do original)
          const fonte = String(r.questions || '').trim();
          const linhasFonte = (fonte ? fonte : String(vaga.pergunta || ''))
            .split(/\r?\n/).map(s => s.trim()).filter(Boolean);

          const pares = linhasFonte.map((L) => {
            const s = String(L || '').trim();
            if (!s) return { pergunta: '', resposta: '' };
            const lastQ = s.lastIndexOf('?');
            if (lastQ !== -1) {
              return { pergunta: s.slice(0, lastQ + 1).trim(), resposta: s.slice(lastQ + 1).trim() };
            }
            const m = s.match(/^(.*?)(?:\s[-–—:]\s)(.+)$/);
            if (m) return { pergunta: m[1].trim(), resposta: m[2].trim() };
            return { pergunta: s, resposta: '' };
          });
          const perguntas = pares.map(p => p.pergunta);
          const respostas = pares.map(p => p.resposta);
      %>
        
        <div class="p-3 border-bottom d-flex align-items-center justify-content-between cand-row"
             data-score="<%= Number(r.score)||0 %>"
             data-d="<%= Number(r.score_D)||0 %>"
             data-i="<%= Number(r.score_I)||0 %>"
             data-s="<%= Number(r.score_S)||0 %>"
             data-c="<%= Number(r.score_C)||0 %>">

          <div class="fs-5 fw-bold text-secondary" style="width: 2.5rem; text-align: right;">
            <%= r.pos %>º
          </div>

          <div class="d-flex align-items-center gap-3 flex-grow-1 ms-3">
            
            <div class="avatar-col d-flex flex-column align-items-center">
              <% if (cid) { %>
                <a href="/candidatos/perfil/<%= cid %>" target="_blank" rel="noopener" title="Ver Perfil Público">
                  <img src="<%= r.foto_perfil || '/img/avatar.png' %>"
                       alt="Foto"
                       class="rounded-circle border"
                       style="width: 52px; height: 52px; object-fit: cover;">
                </a>
              <% } else { %>
                <img src="<%= r.foto_perfil || '/img/avatar.png' %>"
                     class="rounded-circle border"
                     style="width: 52px; height: 52px; object-fit: cover;">
              <% } %>
            </div>

            <div>
              <div class="d-flex align-items-center gap-2">
                <h5 class="mb-0 fw-bold text-dark"><%= r.nome %></h5>
                <% if(r.temVideo) { %>
                  <span class="badge bg-success-subtle text-success border border-success-subtle" style="font-size: 0.65rem;">
                    <i class="bi bi-camera-video-fill"></i> Vídeo Recebido
                  </span>
                <% } %>
              </div>
              <div class="text-muted small mb-2"><i class="bi bi-geo-alt-fill"></i> <%= r.local %></div>

              <div class="d-flex flex-wrap align-items-center actions-gap">
                
                <button type="button" class="btn btn-light btn-sm border" data-bs-toggle="modal" data-bs-target="#<%= modalId %>">
                  <i class="bi bi-card-text"></i> Respostas
                </button>

                <% if (r.explanation || typeof r.score_D !== 'undefined') { %>
                  <button type="button" class="btn btn-light btn-sm border" data-bs-toggle="modal" data-bs-target="#<%= modalIaId %>">
                    <i class="bi bi-robot"></i> Análise IA
                  </button>
                <% } %>
                
                <div class="vr mx-1"></div>

                <% if (r.temVideo) { %>
                  <button type="button" class="btn btn-primary btn-sm fw-semibold" 
                          onclick="abrirVideoCandidato('<%= vaga.id %>', '<%= cid %>')">
                    <i class="bi bi-play-circle-fill me-1"></i> Assistir Vídeo
                  </button>
                <% } else if (r.email) { %>
                  <button type="button" class="btn btn-outline-secondary btn-sm" 
                          onclick="prepararSolicitacao('<%= vaga.id %>', '<%= r.email %>', '<%= r.nome %>', '<%= vaga.cargo %>', '<%= cid %>')">
                    <i class="bi bi-envelope-plus me-1"></i> Solicitar Vídeo
                  </button>
                <% } %>

                <% if (cid) { %>
                  <a href="/candidatos/perfil/<%= cid %>" target="_blank" class="btn btn-link btn-sm text-decoration-none p-0 ms-1" title="Abrir perfil em nova aba">
                    <i class="bi bi-box-arrow-up-right"></i>
                  </a>
                <% } %>

              </div>
            </div>
          </div>

          <div class="text-end ps-3" style="min-width: 190px;">
            <div class="fw-bold fs-5 text-primary">
              <span class="js-metric-value"><%= Number(r.score)||0 %></span>%
            </div>
            <div class="progress bg-secondary-subtle" style="height: 10px; width: 150px; margin-left: auto;">
              <div class="progress-bar js-metric-bar bg-primary" role="progressbar"
                   data-score="<%= Number(r.score)||0 %>"
                   data-d="<%= Number(r.score_D)||0 %>"
                   data-i="<%= Number(r.score_I)||0 %>"
                   data-s="<%= Number(r.score_S)||0 %>"
                   data-c="<%= Number(r.score_C)||0 %>"
                   style="width:<%= Number(r.score)||0 %>%"></div>
            </div>
            <small class="text-muted d-block mt-1 js-metric-label" style="font-size: 0.75rem;">Score Geral</small>
          </div>

        </div>
        <div class="modal fade" id="<%= modalId %>" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header bg-light">
                <h5 class="modal-title">Respostas: <strong><%= r.nome %></strong></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <% if (temAlguma = pares.some(p => p.pergunta || p.resposta)) { %>
                  <ul class="list-group list-group-flush">
                    <% pares.forEach((p, i) => { %>
                      <li class="list-group-item px-0">
                        <div class="fw-bold mb-1 text-primary"><%= (i+1) %>. <%= p.pergunta || 'Pergunta' %></div>
                        <div class="text-dark"><%= p.resposta || '—' %></div>
                      </li>
                    <% }) %>
                  </ul>
                <% } else { %>
                  <p class="text-muted text-center py-3">Nenhuma resposta de texto registrada.</p>
                <% } %>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
              </div>
            </div>
          </div>
        </div>

        <% if (r.explanation || typeof r.score_D !== 'undefined') { %>
          <div class="modal fade" id="<%= modalIaId %>" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
              <div class="modal-content">
                <div class="modal-header bg-light">
                  <h5 class="modal-title"><i class="bi bi-robot me-2"></i>Análise IA: <strong><%= r.nome %></strong></h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                   <% if (typeof r.score_D !== 'undefined') { %>
                      <div class="row g-3 mb-4">
                         <% 
                           const _discPairs = [
                             {k:'Dominância (D)', v:Number(r.score_D)||0, c:'danger'},
                             {k:'Influência (I)', v:Number(r.score_I)||0, c:'warning'},
                             {k:'Estabilidade (S)', v:Number(r.score_S)||0, c:'success'},
                             {k:'Conformidade (C)', v:Number(r.score_C)||0, c:'info'}
                           ]; 
                         %>
                         <% _discPairs.forEach(p => { %>
                           <div class="col-6 col-md-3 text-center">
                             <div class="small fw-bold mb-1"><%= p.k %></div>
                             <div class="progress" style="height: 8px;">
                               <div class="progress-bar bg-<%= p.c %>" style="width:<%= p.v %>%"></div>
                             </div>
                             <div class="h5 mt-1 mb-0"><%= p.v %>%</div>
                           </div>
                         <% }) %>
                      </div>
                  <% } %>

                  <% if (r.explanation) { %>
                    <div class="alert alert-light border">
                      <h6 class="alert-heading fw-bold"><i class="bi bi-chat-quote-fill me-2 text-secondary"></i>Comentário da IA</h6>
                      <p class="mb-0 text-secondary"><%= r.explanation %></p>
                    </div>
                  <% } %>

                  <% if (Array.isArray(r.suggestions) && r.suggestions.length) { %>
                    <div class="card card-body bg-light border-0">
                      <h6 class="fw-bold mb-2">Pontos de Atenção / Sugestões</h6>
                      <ul class="mb-0 ps-3">
                        <% r.suggestions.forEach(sg => { %>
                          <li class="mb-1"><%= sg %></li>
                        <% }) %>
                      </ul>
                    </div>
                  <% } %>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
              </div>
            </div>
          </div>
        <% } %>

      <% }) %>
    </div>
    <% } %>
  </main>

  <div class="modal fade" id="modalSolicitarVideo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-envelope-paper me-2"></i>Enviar Solicitação</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center py-4">
          <div class="mb-3 text-primary">
            <i class="bi bi-camera-reels" style="font-size: 3.5rem;"></i>
          </div>
          <h5 class="fw-bold mb-2">Solicitar Vídeo de Apresentação</h5>
          <p class="text-muted mb-4">
            Você enviará um e-mail para <strong id="modalNomeCandidato" class="text-dark"></strong>.<br>
            O candidato terá <strong>3 dias</strong> para gravar e enviar o vídeo.
          </p>
          <div class="alert alert-warning d-inline-block text-start small">
            <i class="bi bi-exclamation-triangle-fill me-1"></i>
            Certifique-se que o e-mail do candidato está correto.
          </div>
        </div>
        <div class="modal-footer justify-content-center pb-4 border-0">
          <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" id="btnConfirmarSolicitacao" class="btn btn-primary px-4 fw-bold">
            <span id="btnSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
            Enviar Solicitação
          </button>
        </div>
      </div>
    </div>
  </div>

  <%- include('../partials/footer') %>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 1. LÓGICA DO MODAL DE SOLICITAÇÃO
      const modalElement = document.getElementById('modalSolicitarVideo');
      const bsModal = new bootstrap.Modal(modalElement);
      let dadosParaEnvio = null;

      // Função global chamada pelo botão na lista
      window.prepararSolicitacao = function(idVaga, email, nomeCandidato, nomeVaga, candidatoId) {
        dadosParaEnvio = { idVaga, emailCandidato: email, nomeCandidato, nomeVaga, candidatoId };
        document.getElementById('modalNomeCandidato').textContent = nomeCandidato;
        bsModal.show();
      };

      // Ação do botão "Confirmar" dentro do modal
      document.getElementById('btnConfirmarSolicitacao').addEventListener('click', async function() {
        const btn = this;
        const spinner = document.getElementById('btnSpinner');
        
        btn.disabled = true;
        spinner.classList.remove('d-none');

        try {
          const response = await fetch('/solicitar-video', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dadosParaEnvio)
          });
          
          const result = await response.json();
          
          if (result.success) {
            bsModal.hide();
            Swal.fire({ 
              icon: 'success', 
              title: 'Solicitação Enviada!', 
              text: 'O candidato foi notificado por e-mail.',
              confirmButtonColor: '#0d6efd' 
            });
          } else { 
            throw new Error(result.message || 'Erro desconhecido'); 
          }
        } catch (error) {
          Swal.fire('Erro', 'Não foi possível enviar: ' + error.message, 'error');
        } finally {
          btn.disabled = false;
          spinner.classList.add('d-none');
        }
      });

      // 2. LÓGICA DE ORDENAÇÃO (SCORE / DISC)
      const select = document.getElementById('ordenarPor');
      const container = document.getElementById('ranking-list');

      if (select && container) {
        function getRows() {
          return Array.from(container.querySelectorAll('.cand-row'));
        }

        function valueFromRow(row, key) {
          switch (key) {
            case 'score_D': return Number(row.dataset.d || 0);
            case 'score_I': return Number(row.dataset.i || 0);
            case 'score_S': return Number(row.dataset.s || 0);
            case 'score_C': return Number(row.dataset.c || 0);
            default:        return Number(row.dataset.score || 0); // Geral
          }
        }

        function sortBy(key) {
          const rows = getRows();
          
          // Ordena
          rows.sort((a, b) => valueFromRow(b, key) - valueFromRow(a, key));

          // Atualiza DOM e Barras Visuais
          rows.forEach((r, idx) => {
            // Atualiza posição (1º, 2º...)
            const posEl = r.querySelector('.fs-5.fw-bold');
            if (posEl) posEl.textContent = (idx + 1) + 'º';

            // Atualiza Barra e Texto
            const val = valueFromRow(r, key);
            const bar = r.querySelector('.js-metric-bar');
            const num = r.querySelector('.js-metric-value');
            const lbl = r.querySelector('.js-metric-label');

            if (bar) {
              bar.style.width = val + '%';
              // Muda cor da barra dependendo do filtro (visual flair)
              bar.className = 'progress-bar js-metric-bar ' + (key === 'score' ? 'bg-primary' : 'bg-info');
            }
            if (num) num.textContent = String(val);
            if (lbl) lbl.textContent = select.options[select.selectedIndex].text;

            container.appendChild(r); // Move elemento no DOM
          });
        }

        select.addEventListener('change', (e) => sortBy(e.target.value));
        
        // Inicializa ordenação (Score padrão)
        sortBy('score');
      }
    });

    // 3. ABRIR VÍDEO NO CLOUDINARY
    function abrirVideoCandidato(vagaId, candidatoId) {
      // Nome da Cloud configurado no backend (dmjzmau2b conforme fornecido)
      const cloudName = 'dmjzmau2b'; 
      // Public ID deve bater com o padrão salvo no backend
      const publicId = `video_${vagaId}_${candidatoId}`;
      const videoUrl = `https://res.cloudinary.com/${cloudName}/video/upload/vagas_videos/${publicId}.mp4`;

      // Abre em nova aba
      window.open(videoUrl, '_blank');
    }
  </script>
</body>
</html>