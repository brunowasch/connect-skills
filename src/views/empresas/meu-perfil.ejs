<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connect Skills</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/shared/style.css">
  <link rel="icon" type="image/png" href="/img/CONNECT.png?v=2">

  <style>
    :root { --nav-h: 0px !important; }
  body#home { padding-top: 0 !important; }
    main#content-main { margin-top: var(--header-h); }
    .perfil-foto { width: 160px; height: 160px; object-fit: cover; border-radius: 50%; }
    @media (max-width: 576px) { .perfil-foto { width: 120px; height: 120px; } }
    .icon-sm { font-size: 1.1rem; }
    .section-title { display: flex; align-items: center; gap: .5rem; font-weight: 600; }
    .perfil-link { color: #000; text-decoration: none; transition: color .2s; }
    .perfil-link:hover { color: #0d6efd; }
    .text-clip { max-width: 520px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  </style>
</head>
<body class="bg-light">
  <% var sucesso = typeof sucesso !== 'undefined' ? sucesso : (typeof sucessoVaga !== 'undefined' ? sucessoVaga : false); %>
  <% var erro = typeof erro !== 'undefined' ? erro : false; %>

  <%- include('../partials/header-empresa') %>

  <main class="container pb-5">
    <% if (sucesso) { %>
      <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
        <%= sucesso %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
      </div>
    <% } %>
    <% if (erro) { %>
      <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
        <%= erro %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
      </div>
    <% } %>

    <h2 class="mb-4 mt-4">Meu perfil</h2>
    <section class="card border-1 shadow-sm rounded-4 p-3 p-md-4 mb-4">
      <div class="d-flex gap-3 align-items-start flex-wrap">
        <img class="perfil-foto border" src="<%= empresa?.foto_perfil || '/img/avatar.png' %>" alt="Foto da empresa" />

        <div class="flex-grow-1">
          <div class="d-flex align-items-start justify-content-between flex-wrap gap-2">
            <div>
              <h3 class="mb-1"><%= empresa?.nome_empresa || 'Minha empresa' %></h3> 
              <div class="text-muted">
                <i class="bi bi-geo-alt me-1"></i>
                <%= [empresa?.cidade, empresa?.estado, empresa?.pais].filter(Boolean).join(', ') || 'Localidade não informada' %>
              </div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <a class="btn btn-outline-primary btn-sm" href="/empresa/publicar-vaga">
                <i class="bi bi-plus-square me-1"></i> Publicar vaga
              </a>
              <a class="btn btn-outline-secondary btn-sm" href="/empresa/editar-empresa">
                <i class="bi bi-pencil-square me-1"></i> Editar perfil
              </a>
              <button
                class="btn btn-sm"
                title="Copiar link público do perfil da empresa"
                data-share-url="<%= perfilPublicoUrl %>"
                onclick="copiarLinkPerfilPublico(this)">
                <i class="bi bi-link-45deg me-1"></i>
              </button>
              <small id="msgCopiado" class="text-success ms-1" style="display:none;">Copiado!</small>
            </div>
          </div>

          <p class="mt-3 mb-0"><%= empresa?.descricao || 'Sem descrição no momento.' %></p>
          <% if (empresa?.telefone) { %>
            <div class="mt-2 text-muted"><i class="bi bi-telephone me-1"></i><%= empresa.telefone %></div>
          <% } %>
        </div>
      </div>
    </section>

    <section class="card border-1 shadow-sm rounded-4 p-3 p-md-4 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Vagas Publicadas</h5>
        <a href="/empresa/publicar-vaga" class="text-decoration-none" title="Publicar vaga">
          <i class="bi bi-plus-square fs-6"></i>
        </a>
      </div>

      <% if (!vagasPublicadas || !vagasPublicadas.length) { %>
        <div class="text-muted">Você ainda não publicou vagas.</div>
      <% } else { %>
        <div class="list-group list-group-flush">
          <% vagasPublicadas.forEach(v => { %>
            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" href="/empresa/vaga/<%= v.id %>">
              <div class="text-clip">
                <strong><%= v.cargo || 'Vaga' %></strong>
                <span class="text-muted ms-2">
                  <% const areas = (v.vaga_area || []).map(a => a.area_interesse?.nome).filter(Boolean); %>
                  <% if (areas.length) { %>• <%= areas.join(', ') %><% } %>
                </span>
              </div>
              <i class="bi bi-chevron-right"></i>
            </a>
          <% }) %>
        </div>
      <% } %>
    </section>

    <section class="card border-1 shadow-sm rounded-4 p-3 p-md-4 mb-4">
      <div class="d-flex justify-content-between align-items-center">
        <div class="section-title">
          <i class="bi bi-link-45deg text-primary icon-sm"></i>
          <span>Links do perfil</span>
        </div>
        <a href="/empresa/editar-empresa" class="text-decoration-none" title="Editar links">
          <i class="bi bi-pencil-square"></i>
        </a>
      </div>

      <ul class="list-group list-group-flush mt-2">
        <% if (links && links.length) { %>
          <% links.forEach(link => { %>
            <li class="list-group-item d-flex align-items-center gap-3">
              <i class="bi bi-box-arrow-up-right icon-sm"></i>
              <a class="perfil-link" href="<%= link.url %>" target="_blank" rel="noopener noreferrer">
                <%= link.url %><span class="text-muted">
              </a>
            </li>
          <% }) %>
        <% } else { %>
          <li class="list-group-item text-muted">Nenhum link cadastrado</li>
        <% } %>
      </ul>
    </section>

    <section class="card border-1 shadow-sm rounded-4 p-3 p-md-4">
      <div class="d-flex justify-content-between align-items-center">
        <div class="section-title">
          <i class="bi bi-paperclip icon-sm"></i>
          <span>Meus anexos</span>
        </div>
        <a href="/empresa/editar-empresa" class="text-decoration-none" title="Gerenciar anexos">
          <i class="bi bi-pencil-square"></i>
        </a>
      </div>

      <% /* helper local para tamanho legível */ %>
      <% function hfs(bytes){ 
           if(!bytes||bytes<=0) return '0 B';
           const thresh=1024, units=['KB','MB','GB','TB'];
           let b=bytes, u=-1;
           while(Math.abs(b)>=thresh && u<units.length-1){ b/=thresh; u++;
           }
           return (u<0? bytes+' B' : b.toFixed(1)+' '+units[u]);
         } %>

      <div class="table-responsive mt-2">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Tipo</th>
              <th>Tamanho</th>
              <th>Enviado em</th>
              <th class="text-end">Ações</th>
            </tr>
          </thead>
          <tbody>
            <% if (!anexos || !anexos.length) { %>
              <tr><td colspan="5" class="text-muted">Nenhum anexo enviado</td></tr>
            <% } else { %>
              <% anexos.forEach(ax => { 
                   const mime = (ax.mime || '').toLowerCase();
                   const isPdf = mime === 'application/pdf';
                   const isImg = mime.startsWith('image/');
              %>
                <tr>
                  <td class="text-truncate" style="max-width: 380px;"><%= ax.nome %></td>
                  <td><%= ax.mime || '-' %></td>
                  <td><%= hfs(ax.tamanho) %></td>
                  <td><%= ax.criadoEm ? new Date(ax.criadoEm).toLocaleString('pt-BR') : '-' %></td>
                  <td class="text-end d-flex gap-2 justify-content-end">
                    <% if (isPdf || isImg) { %>
                      <a href="/public/empresa/anexos/<%= ax.id %>/abrir" target="_blank" rel="noopener" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-box-arrow-up-right"></i> Abrir
                      </a>
                    <% } else { %>
                      <a href="<%= ax.url %>" class="btn btn-sm btn-outline-secondary" download>
                        Baixar
                      </a>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
      <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toastCopyPerfil" class="toast text-bg-success border-0" role="alert">
          <div class="d-flex">
            <div class="toast-body">Link do perfil público copiado com sucesso!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function copiarLinkPerfilPublico(btn) {
      const empresaId = btn.getAttribute('data-empresa-id');
      const url = `${window.location.origin}/empresa/perfil/${empresaId}`;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url)
          .then(() => mostrarMsgCopiado())
          .catch(() => fallbackCopy(url));
      } else {
        fallbackCopy(url);
      }
    }

    function fallbackCopy(texto) {
      try {
        const input = document.createElement('input');
        input.value = texto;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        mostrarMsgCopiado();
      } catch (_) {
        alert('Copie o link: ' + texto);
      }
    }

    function mostrarMsgCopiado() {
      const msg = document.getElementById('msgCopiado');
      if (!msg) return;
      msg.style.display = 'inline';
      setTimeout(() => (msg.style.display = 'none'), 1500);
    }
  </script>
<script>
  function copiarLinkPerfilPublico(btn) {
    const url = btn.getAttribute('data-share-url');
    if (!url) return;
    const fullUrl = window.location.origin + url;

    navigator.clipboard.writeText(fullUrl)
      .then(() => {
        const toastEl = document.getElementById('toastCopyPerfil');
        if (toastEl) {
          const t = new bootstrap.Toast(toastEl);
          toastEl.style.display = 'block';
          t.show();
        }
      })
      .catch(() => {
        prompt('Não foi possível copiar automaticamente. Copie o link abaixo:', fullUrl);
      });
  }
</script>
</body>
</html>
