<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connect Skills</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/shared/style.css">
  <link rel="icon" type="image/png" href="/img/CONNECT.png?v=2">
  <style>
    :root { --nav-h: 0px !important; }
    body#home { padding-top: 0 !important; }
    
    .tag-area {
      background-color: #f0f7ff;
      color: #0d6efd;
      border: 1px solid #cfe2ff;
      border-radius: 8px;
      padding: 8px 16px;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-remover-tag {
      border: none;
      background: none;
      padding: 0;
      color: #0d6efd;
      cursor: pointer;
      display: flex;
      align-items: center;
      font-size: 1.2rem;
    }
    .btn-remover-tag:hover { color: #dc3545; }
    .cursor-pointer { cursor: pointer; }
  </style>
</head>
<body>
  <%- include('../partials/header') %>
  <%- include('../partials/flash-messages') %>

  <main class="container py-5 mt-5" style="max-width: 700px;">
    <div class="text-center mb-5">
      <h2 class="fw-bold text-primary">Edite suas Áreas de Interesse</h2>
      <p class="text-muted">Pesquise e selecione as áreas em que você deseja atuar.</p>
    </div>

    <form action="/candidato/editar-areas" method="POST" id="formEditarAreas">
      <input type="hidden" name="candidato_id" value="<%= candidatoId %>">
      
      <div class="position-relative mb-4">
        <div class="input-group input-group-lg shadow-sm">
          <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
          <input type="text" id="busca-area" class="form-control border-start-0" placeholder="Digite para pesquisar uma área...">
        </div>
        
        <ul id="lista-sugestoes-area" class="list-group position-absolute w-100 shadow d-none" style="z-index: 1050; max-height: 250px; overflow-y: auto;">
          </ul>
      </div>

      <div class="card border-0 bg-light rounded-4 p-4">
        <h6 class="text-uppercase small fw-bold text-muted mb-3">Suas áreas selecionadas:</h6>
        <div id="container-tags-areas" class="d-flex flex-wrap gap-2">
          </div>
      </div>

      <input type="hidden" name="areasSelecionadas" id="areas-input">

      <div class="d-flex justify-content-center gap-3 mt-5">
        <a href="/candidato/meu-perfil" class="btn btn-outline-secondary px-4 py-2">Cancelar</a>
        <button type="submit" class="btn btn-primary px-5 py-2 fw-bold shadow-sm">Salvar Alterações</button>
      </div>
    </form>
  </main>

  <script>
    (function() {
      // 1. Dados iniciais vindos do servidor
      const todasAsAreas = <%- JSON.stringify(todasOpcoes || []) %>;
      // 'areasAtuais' deve vir do controller como um array de objetos {id, nome}
      let selecionadas = <%- JSON.stringify(areasAtuaisObjetos || []) %>;

      const inputBusca = document.getElementById('busca-area');
      const listaSugestoes = document.getElementById('lista-sugestoes-area');
      const containerTags = document.getElementById('container-tags-areas');
      const hiddenInput = document.getElementById('areas-input');

      // Inicializa
      renderizarTags();

      // 2. Lógica de Busca
      inputBusca.addEventListener('input', function() {
        const termo = this.value.toLowerCase().trim();
        listaSugestoes.innerHTML = '';

        if (termo.length < 1) {
          listaSugestoes.classList.add('d-none');
          return;
        }

        const filtradas = todasAsAreas.filter(area => 
          area.nome.toLowerCase().includes(termo) && 
          !selecionadas.find(s => s.id === area.id)
        );

        if (filtradas.length > 0) {
          filtradas.forEach(area => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action cursor-pointer py-3';
            li.textContent = area.nome;
            li.onclick = () => adicionarArea(area);
            listaSugestoes.appendChild(li);
          });
          listaSugestoes.classList.remove('d-none');
        } else {
          listaSugestoes.classList.add('d-none');
        }
      });

      function adicionarArea(area) {
        if (!selecionadas.find(s => s.id === area.id)) {
          selecionadas.push(area);
          inputBusca.value = '';
          listaSugestoes.classList.add('d-none');
          renderizarTags();
        }
      }

      window.removerArea = function(id) {
        selecionadas = selecionadas.filter(a => a.id !== id);
        renderizarTags();
      };

      function renderizarTags() {
        containerTags.innerHTML = '';
        if (selecionadas.length === 0) {
            containerTags.innerHTML = '<span class="text-muted italic small">Nenhuma área selecionada.</span>';
        }

        selecionadas.forEach(area => {
          const tag = document.createElement('div');
          tag.className = 'tag-area animate__animated animate__fadeIn';
          tag.innerHTML = `
            <span>${area.nome}</span>
            <button type="button" class="btn-remover-tag" onclick="removerArea(${area.id})">
              <i class="bi bi-x-circle-fill"></i>
            </button>
          `;
          containerTags.appendChild(tag);
        });

        // Envia apenas os nomes ou IDs conforme seu backend espera
        // Se seu backend espera nomes: .map(a => a.nome)
        // Se espera IDs: .map(a => a.id)
        hiddenInput.value = JSON.stringify(selecionadas.map(a => a.nome));
      }

      document.addEventListener('click', (e) => {
        if (!inputBusca.contains(e.target)) listaSugestoes.classList.add('d-none');
      });
    })();
  </script>
</body>
</html>