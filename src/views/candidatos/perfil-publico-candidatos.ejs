<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>
    <%= [candidato?.nome, candidato?.sobrenome].filter(Boolean).join(' ') || 'Candidato' %> | Connect Skills
  </title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/img/CONNECT.png?v=2">
  <style>
    :root {
      --cs-bg: #e9ecef;
      --cs-card: #fff;
      --cs-muted: #6c757d;
      --cs-shadow: 0 0 10px rgba(0,0,0,0.06);
    }
    body { background-color: var(--cs-bg); font-family: 'Montserrat', sans-serif; }
    .perfil-card, .section-card {
      background: var(--cs-card);
      border-radius: 14px;
      box-shadow: var(--cs-shadow);
    }
    .perfil-card { padding: 24px; }
    .avatar {
      width: 128px; height: 128px; object-fit: cover;
      border-radius: 50%; border: 4px solid #fff; box-shadow: 0 6px 18px rgba(0,0,0,.08);
      background: #f8f9fa;
    }
    .name { font-weight: 800; line-height: 1.1; }
    .muted { color: var(--cs-muted); }
    .chip { border-radius: 999px; padding: .35rem .75rem; background: #f1f3f5; font-weight: 600; }
    .link-pill { display: inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border-radius: 999px; background:#f8f9fa; border:1px solid #eee; text-decoration:none; color:inherit; }
    .link-pill:hover { background:#f1f3f5; }
    .file-row { display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    .file-meta { font-size:.9rem; color:var(--cs-muted); }
    .section-card { padding: 20px; }
    .section-title { font-weight: 800; font-size: 1.05rem; margin-bottom: .75rem; }
    .divider { height:1px; background:#eee; margin: .75rem 0 1rem; }
    @media (max-width: 576px) {
      .avatar { width: 96px; height: 96px; }
    }
    .perfil-link {
      color: #212529;              /* cor padrão (quase preto) */
      text-decoration: none;       /* tira o sublinhado */
      transition: color 0.3s ease; /* suaviza a troca da cor */
    }

    .perfil-link:hover {
      color: #0d6efd;              /* azul do Bootstrap */
      text-decoration: underline;  /* opcional: sublinha ao passar o mouse */
    }
    .sobre-mim {
      font-size: 0.95rem;   /* menor que o texto normal */
      color: #495057;       /* cor mais suave */
    }
  </style>
</head>
<body>
<%
function toViewUrl(u) {
  try {
    let url = String(u || '').trim();
    if (!url) return '';

    // Google Drive: /file/d/{id} -> visualização
    if (/drive\.google\.com\/file\/d\//.test(url)) {
      const id = url.match(/\/file\/d\/([^/]+)/)?.[1];
      if (id) return `https://drive.google.com/uc?export=view&id=${id}`;
    }

    // Dropbox: forçar visualização
    url = url.replace(/\?dl=1\b/, '?raw=1').replace(/\?dl=0\b/, '?raw=1');

    // Cloudinary: remover download forçado
    url = url
      .replace(/\/upload\/(?:[^/]*,)?fl_attachment(?:[^/]*,)?\//, '/upload/')
      .replace(/(\?|&)fl_attachment(=[^&]*)?/gi, '')
      .replace(/(\?|&)response-content-disposition=attachment/gi, '');

    // S3/Genérico: trocar attachment -> inline
    url = url.replace(/response-content-disposition=attachment/gi, 'response-content-disposition=inline');

    // genérico: download=1 -> remove
    url = url.replace(/(\?|&)download=1\b/gi, '$1');

    if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
    return url;
  } catch (e) {
    return u;
  }
}
%>
  <main class="container py-5">
    <section class="perfil-card mb-4">
      <div class="d-flex flex-column flex-md-row align-items-center gap-3">
        <img class="avatar" src="<%= fotoPerfil || '/img/avatar.png' %>" alt="Foto do candidato">
        <div class="text-center text-md-start">
          <h1 class="h3 name mb-1 d-flex align-items-center justify-content-center justify-content-md-start gap-2">
            <%= [candidato?.nome, candidato?.sobrenome].filter(Boolean).join(' ') || 'Candidato' %>
            <button class="btn btn-sm btn-outline-secondary p-1" id="btnCopiarLink"
                    data-share-url="<%= perfilShareUrl %>" title="Copiar link público do perfil">
              <i class="bi bi-link-45deg"></i>
            </button>
          </h1>
          <div class="toast position-fixed bottom-0 end-0 m-3 text-bg-success" id="toastCopy" role="alert" aria-live="assertive" aria-atomic="true" style="display:none;">
            <div class="toast-body">
              Link copiado para a área de transferência!
            </div>
          </div>
          <%
            const loc = (localidade || '').trim();
            const tel = (typeof telefoneExibicao === 'string' && telefoneExibicao.trim())
              ? telefoneExibicao.trim()
              : String(candidato?.telefone || '')
                  .replace(/\+?undefined-?/gi, '') 
                  .trim();

            const dn = candidato?.data_nascimento instanceof Date
              ? candidato.data_nascimento
              : (candidato?.data_nascimento ? new Date(candidato.data_nascimento) : null);

            const dnStr = dn && !isNaN(dn.getTime())
              ? dn.toLocaleDateString('pt-BR')
              : '';
          %>
          <p class="mb-1 muted">
            <i class="bi bi-geo-alt"></i> <%= loc || 'Localidade não informada' %>
          </p>
          <div class="d-flex flex-wrap justify-content-center justify-content-md-start gap-3 mt-2">
            <% if (dnStr) { %><span class="muted"><i class="bi bi-calendar3"></i> Data de nascimento: <%= dnStr %></span><% } %>
            <% if (tel)  { %><span class="muted"><i class="bi bi-telephone"></i> <%= tel %></span><% } %>
          </div>
          <% 
          const sobreMim = (candidato?.descricao || '').trim(); %>
          <% if (sobreMim) { %>
            <div class="mt-2">
              <div class="small text-muted mb-1 d-flex align-items-center gap-2">
                <i class="bi bi-person-lines-fill icon-sm"></i>
                <strong>Sobre mim</strong>
              </div>
              <p class="sobre-mim mb-0" style="white-space: pre-wrap;"><%= sobreMim %></p>
            </div>
          <% } %>
        </div>
      </div>

      <% if (Array.isArray(areas) && areas.length) { %>
        <p class="mt-4">
          Áreas de interesse:
        </p>
        <div class="d-flex flex-wrap gap-2 justify-content-center justify-content-md-start">
          <% areas.forEach(function(a){ %>
            <span class="chip"><i class="bi bi-briefcase"></i> <%= a %></span>
          <% }); %>
        </div>
      <% } %>
    </section>

    <div class="row g-3">

      <!-- Links -->
      <div class="col-12 col-lg-6">
        <section class="section-card h-100">
          <div class="section-title"><i class="bi bi-link-45deg"></i> Links</div>
          <div class="divider"></div>
          <% 
            const linksArr = Array.isArray(links) ? links : [];
            const iconFor = (url) => {
              const u = String(url || '').toLowerCase();
              if (u.includes('linkedin')) return 'bi-linkedin';
              if (u.includes('github')) return 'bi-github';
              if (u.includes('behance')) return 'bi-behance';
              if (u.includes('dribbble')) return 'bi-dribbble';
              if (u.includes('youtube')) return 'bi-youtube';
              if (u.includes('instagram')) return 'bi-instagram';
              if (u.includes('facebook')) return 'bi-facebook';
              if (u.includes('notion')) return 'bi-journal-text';
              if (u.includes('vercel') || u.includes('netlify') || u.includes('render')) return 'bi-globe';
              return 'bi-box-arrow-up-right';
            };
            const labelFor = (l, url) => (l && l.trim()) || (new URL(url).hostname.replace('www.',''));
          %>
          <% if (!linksArr.length) { %>
            <div class="text-muted">Nenhum link informado.</div>
          <% } else { %>
            <ul class="list-group list-group-flush">
              <% linksArr.forEach(link => { 
                  let url = (link?.url || '').trim();
                  if (!url) return;
                  if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
              %>
                <li class="list-group-item d-flex align-items-center gap-4">
                  <i class="bi bi-box-arrow-up-right icon-sm"></i>
                  <a href="<%= url %>" target="_blank" rel="noopener noreferrer" class="perfil-link">
                    <%= link?.url %>
                  </a>
                </li>
              <% }) %>
            </ul>
          <% } %>
        </section>
      </div>

      <!-- Arquivos/Anexos -->
      <div class="col-12 col-lg-6">
        <section class="section-card h-100">
          <div class="section-title"><i class="bi bi-paperclip"></i> Arquivos</div>
          <div class="divider"></div>
          <%
            const files = Array.isArray(arquivos) ? arquivos : [];
            function humanSize(bytes){
              const n = Number(bytes || 0);
              if (!isFinite(n) || n <= 0) return '—';
              const k = 1024;
              const units = ['KB','MB','GB','TB'];
              let v = n, i = -1;
              do { v /= k; i++; } while (v >= k && i < units.length - 1);
              return v.toFixed(1) + ' ' + units[i];
            }
            const iconForMime = (m) => {
              const mm = String(m || '').toLowerCase();
              if (mm.includes('pdf')) return 'bi-file-earmark-pdf';
              if (mm.includes('image')) return 'bi-file-earmark-image';
              if (mm.includes('word') || mm.includes('doc')) return 'bi-file-earmark-word';
              if (mm.includes('sheet') || mm.includes('excel') || mm.includes('xls')) return 'bi-file-earmark-spreadsheet';
              if (mm.includes('zip') || mm.includes('rar')) return 'bi-file-earmark-zip';
              if (mm.includes('text') || mm.includes('plain') || mm.includes('txt')) return 'bi-file-earmark-text';
              return 'bi-file-earmark';
            };
          %>
          <% if (!files.length) { %>
            <div class="text-muted">Nenhum arquivo anexado.</div>
          <% } else { %>
            <div class="vstack gap-2">
              <% files.forEach(function(f){
                   const url = (f?.url || '').trim();
                   if (!url) return;
                   const nome = (f?.nome || 'Arquivo');
                   const mime = (f?.mime || '');
                   const tam  = (typeof f?.tamanho === 'number' ? f.tamanho : null);
              %>
                <div class="file-row p-2 border rounded">
                  <div class="d-flex align-items-center gap-2">
                    <i class="bi <%= iconForMime(mime) %> fs-5"></i>
                    <div>
                      <div class="fw-semibold"><%= nome %></div>
                      <div class="file-meta">
                        <%= mime || '—' %> · <%= humanSize(tam) %>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <a href="/public/candidato/anexos/<%= encodeId(f.id) %>/abrir" target="_blank" rel="noopener" class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-box-arrow-up-right"></i> Abrir
                    </a>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } %>
        </section>
      </div>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  (function(){
    const btn = document.getElementById('btnCopiarLink');
    const toastEl = document.getElementById('toastCopy');
    if (!btn) return;

    btn.addEventListener('click', async () => {
      const publicUrl = btn.getAttribute('data-share-url');
      try {
        await navigator.clipboard.writeText(publicUrl);
        if (toastEl) {
          const t = new bootstrap.Toast(toastEl);
          toastEl.style.display = 'block';
          t.show();
        }
      } catch {
        alert('Não foi possível copiar automaticamente. Copie: ' + publicUrl);
      }
    });
  })();
</script>
</body>
</html>