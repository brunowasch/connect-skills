<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connect Skills</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/shared/style.css">
  <link rel="icon" type="image/png" href="/img/CONNECT.png?v=2">

  <style>
    :root { --nav-h: 0px !important; }
    body#home-candidato { margin: 0; padding-top: 0 !important; }
    main#content-main { margin-top: 0 !important; }
    .card-ghost { border:1px dashed rgba(0,0,0,.15); background:#fff; }
    .rounded-2xl { border-radius: 1rem; }
    .shadow-soft { box-shadow: 0 6px 24px rgba(0,0,0,.06); }
    .pill { display:inline-block; padding:.25rem .6rem; border-radius:999px; background:#f1f3f5; font-size:.85rem; margin:.15rem .25rem .15rem 0; }
    .perfil-logo { width: 64px; height: 64px; object-fit: cover; }
    .card-vaga { border:1px solid rgba(0,0,0,.06); }
    .section-title { font-weight:700; font-size:1rem; letter-spacing:.2px; }
    .muted { color:#6c757d; }
    .grid-areas { display:flex; flex-wrap:wrap; gap:.4rem; }
    .kpi .num { font-weight:800; font-size:1.25rem; }
  </style>
</head>
<body id="home-candidato">
  <%- include('../partials/header-candidato') %>
  <%- include('../partials/flash-messages') %>

  <main id="content-main" class="container">
    <%
      const user = (typeof usuario !== 'undefined' && usuario) ? usuario : {};
      const cand = (typeof candidato !== 'undefined') ? candidato : {};

      const nomeUser  = cand?.nome || 'Candidato';
      const sobrenome = cand?.sobrenome || '';

      const localidadeResolved = (typeof localidade !== 'undefined') ? localidade : (cand.localidade || 'Localidade n√£o informada');

      const fotoPerfilResolved =
        (typeof candFotoPerfil !== 'undefined' && candFotoPerfil)
          ? candFotoPerfil
          : (
              (typeof fotoPerfil !== 'undefined' && fotoPerfil)
                ? fotoPerfil
                : ''
            );

      const fotoUrlCandidates = [
        cand?.foto_perfil,
        user?.foto_perfil,
        cand?.fotoPerfil,
        user?.fotoPerfil,
        fotoPerfilResolved || null
      ].filter(v => typeof v === 'string' && v.trim() !== '');

      const fotoUrl = (fotoUrlCandidates.length ? fotoUrlCandidates[0] : '/img/avatar.png');

      const _areas = (typeof areas !== 'undefined') ? areas : (cand.areas || []);
      const _links  = (typeof links  !== 'undefined' && Array.isArray(links))  ? links  : [];
      const _anexos = (typeof anexos !== 'undefined' && Array.isArray(anexos)) ? anexos : [];

      const _historico =
        (typeof historico !== 'undefined' && Array.isArray(historico))
          ? historico
          : (
              (typeof historicoAplicado !== 'undefined' && Array.isArray(historicoAplicado))
                ? historicoAplicado
                : []
            );

      const _vagas = (typeof vagas !== 'undefined' && Array.isArray(vagas)) ? vagas : [];

      const areasSel = cand?.candidato_area || [];
      const linksPerf           = _links;
      const anexosList          = _anexos;
      const historicoAplicacoes = (typeof historico !== 'undefined') ? historico : [];
      const vagasRecomendadas   = (typeof vagas !== 'undefined') ? vagas : [];

      // --- Telefone (usa DDD + n√∫mero, com fallback do pr√≥prio cand.telefone) ---
      const hasDDD = (typeof ddd !== 'undefined') && String(ddd || '').trim() !== '';
      const hasNum = (typeof numeroFormatado !== 'undefined') && String(numeroFormatado || '').trim() !== '';
      const hasTel = (hasDDD && hasNum) || !!cand?.telefone;

      // --- Itens da barra de progresso (ignora links e anexos) ---
      const hasNasc  = !!cand?.data_nascimento;
      const hasFoto  = (fotoUrl && fotoUrl !== '/img/avatar.png');
      const hasLocal = !!(localidadeResolved && localidadeResolved !== 'Localidade n√£o informada');
      const hasAreas = Array.isArray(_areas) && _areas.length >= 1;

      const checklist        = [hasFoto, hasLocal, hasTel, hasNasc, hasAreas];
      const totalSteps       = checklist.length;
      const doneSteps        = checklist.filter(Boolean).length;
      const profileCompletion = Math.max(0, Math.min(100, Math.round((doneSteps / totalSteps) * 100)));

      const aplicadasCount =
        (typeof candidaturasAplicadasCount !== 'undefined' && Number.isFinite(candidaturasAplicadasCount))
          ? Number(candidaturasAplicadasCount)
          : (Array.isArray(historicoAplicacoes) ? historicoAplicacoes.length : 0);

      function formatStatus(s) {
        if (!s) return '‚Äî';
        const map = {
          recebido: 'Recebido',
          visualizado: 'Visualizado',
          entrevista: 'Convidado para entrevista',
          recusado: 'Recusado',
          aprovado: 'Aprovado',
          em_analise: 'Em an√°lise'
        };
        return map[s] || s;
      }
    %>

    <h2 class="mt-4 mb-4">Dashboard pessoal</h2>

    <!-- HERO -->
    <div class="bg-white rounded-2xl shadow-soft p-4 p-md-5 mb-4">
      <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
        <div class="d-flex align-items-center gap-3">
          <img
            src="<%= fotoUrl %>"
            class="rounded-circle border perfil-logo"
            alt="Foto do perfil"
          >
          <div>
            <div class="h4 m-0">Ol√°, <%= candidato.nome %> <%= candidato.sobrenome %>! üëã</div>
            <div class="small muted">
              <i class="bi bi-geo-alt me-1"></i> <%= localidadeResolved %>
            </div>
            <div class="muted">Bem-vindo ao seu painel do Connect Skills</div>
          </div>
        </div>

        <div class="d-flex flex-wrap justify-content-md-end gap-3 mt-3 mt-md-0">
          <a href="/candidato/meu-perfil" class="btn btn-primary">
            <i class="bi bi-person me-1"></i>
            Meu perfil
          </a>
          <a href="/candidato/editar-perfil" class="btn btn-outline-primary">
            <i class="bi bi-pencil-square me-1"></i>
            Editar perfil
          </a>
        </div>
      </div>
    </div>

    <!-- BARRA DE PROGRESSO (s√≥ mostra se incompleto) -->
    <% if (profileCompletion < 100) { %>
      <div class="bg-white rounded-2xl shadow-soft p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="section-title">
            <i class="bi bi-rocket-takeoff me-1"></i>
            Complete seu perfil para ter melhores recomenda√ß√µes
          </div>
          <div class="small muted"><%= profileCompletion %>%</div>
        </div>

        <div class="progress">
          <div class="progress-bar" data-progress="<%= profileCompletion %>"></div>
        </div>


        <div class="d-flex gap-2 mt-3 flex-wrap">
          <% if (!hasFoto) { %><a href="/candidato/editar-perfil" class="btn btn-sm btn-outline-primary">Adicionar foto</a><% } %>
          <% if (!hasLocal) { %><a href="/candidato/editar-perfil" class="btn btn-sm btn-outline-primary">Definir localidade</a><% } %>
          <% if (!hasTel)   { %><a href="/candidato/editar-perfil" class="btn btn-sm btn-outline-primary">Adicionar telefone</a><% } %>
          <% if (!hasNasc)  { %><a href="/candidato/editar-perfil" class="btn btn-sm btn-outline-primary">Informar data de nascimento</a><% } %>
          <% if (!hasAreas) { %><a href="/candidato/editar-areas" class="btn btn-sm btn-outline-primary">Selecionar √°reas</a><% } %>
        </div>
      </div>
    <% } %>

    <!-- KPIs -->
    <div class="row g-4 mb-4">
      <div class="col-12 col-lg-4">
        <div class="bg-white rounded-2xl shadow-soft p-4 text-center h-100 dashboard-kpi">
          <i class="bi bi-search fs-3"></i>
          <div class="fw-bold fs-5"><%= vagasRecomendadas.length %></div>
          <div class="muted small">Vagas encontradas</div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="bg-white rounded-2xl shadow-soft p-4 text-center h-100 dashboard-kpi">
          <i class="bi bi-send-check fs-3"></i>
          <div class="fw-bold fs-5"><%= aplicadasCount %></div>
          <div class="muted small">Vagas aplicadas</div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="bg-white rounded-2xl shadow-soft p-4 h-100 dashboard-kpi">
          <div class="d-flex justify-content-between align-items-center mb-2 w-100">
            <div class="section-title">
              <i class="bi bi-diagram-3 me-1"></i>
              √Åreas de interesse
            </div>

            <a href="/candidato/editar-areas" class="text-decoration-none" title="Editar √°reas">
              <i class="bi bi-pencil-square"></i>
            </a>
          </div>
<div class="col-12 col-lg-4">
  <div class="bg-white rounded-2xl shadow-soft p-4 h-100 d-flex flex-column">

    <!-- HEADER -->
    <div class="position-relative mb-3">
      <div class="section-title text-center m-0">
        <i class="bi bi-diagram-3 me-2 text-primary"></i>
        √Åreas de Interesse
      </div>

      <a href="/candidato/editar-areas"
         class="position-absolute top-0 end-0 text-muted"
         title="Editar √°reas">
        <i class="bi bi-pencil-square fs-5"></i>
      </a>
    </div>

    <!-- CONTE√öDO -->
    <div class="flex-grow-1 d-flex align-items-center justify-content-center">
      <% if (!_areas || _areas.length === 0) { %>
        <div class="card-ghost p-3 rounded-2xl text-center w-100">
          <div class="small muted mb-2">Nenhuma √°rea selecionada</div>
          <a class="btn btn-primary btn-sm rounded-pill px-3"
             href="/candidato/editar-areas">
            Configurar
          </a>
        </div>
      <% } else { %>
        <div class="d-flex flex-wrap justify-content-center gap-2 w-100">
          <% _areas.slice(0, 8).forEach(function (nomeArea) { %>
            <span
              class="badge rounded-pill fw-normal px-3 py-2"
              style="
                background-color: #f3e8ff;
                color: #6f42c1;
                border: 1px solid #e9d5ff;
                font-size: 0.8rem;
                white-space: nowrap;
              ">
              <%= nomeArea %>
            </span>
          <% }) %>

          <% if (_areas.length > 8) { %>
            <span
              class="badge rounded-pill bg-light text-muted border fw-normal px-3 py-2"
              style="font-size: 0.8rem;">
              +<%= _areas.length - 8 %>
            </span>
          <% } %>
        </div>
      <% } %>
    </div>

  </div>
</div>

        </div>
      </div>
    </div>

    <div class="row g-4 mt-4">
      <!-- VAGAS RECOMENDADAS -->
      <div class="col-12 col-lg-7">
        <div class="bg-white rounded-2xl shadow-soft p-4 h-100">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="section-title">
              <i class="bi bi-stars me-1"></i>
              Vagas recomendadas
            </div>

            <a href="/candidatos/vagas" class="btn btn-sm btn-outline-primary">
              Ver todas
            </a>
          </div>

          <% if (!vagasRecomendadas.length) { %>
            <div class="card-ghost p-4 rounded-2xl text-center">
              <div class="muted">
                Ainda n√£o temos recomenda√ß√µes. Complete seu perfil e selecione √°reas para melhorar as sugest√µes.
              </div>
              <a class="btn btn-primary btn-sm mt-2" href="/candidato/editar-areas">
                Selecionar √°reas
              </a>
            </div>
          <% } else { %>
            <% const tipoMap = { Presencial: 'Presencial', Home_Office: 'Home Office', H_brido: 'H√≠brido' }; %>

            <% vagasRecomendadas.slice(0, 3).forEach(function (vaga) { %>
              <div class="card-vaga bg-white rounded-2xl p-3 p-md-4 mb-3">
                <div class="d-flex gap-3 align-items-start flex-wrap">
                    <a href="/empresa/perfil/<%= (vaga.empresa ? vaga.empresa.id : '') %>">
                      <img
                        src="<%= (vaga.empresa && vaga.empresa.foto_perfil && vaga.empresa.foto_perfil.trim() !== '') 
                          ? vaga.empresa.foto_perfil 
                          : '/img/avatar.png' %>"
                        alt="Logo da empresa"
                        class="rounded-circle border perfil-logo"
                        width="80" height="80"
                      >
                    </a>

                  <div class="flex-grow-1">
                    <h5 class="mb-0 fw-bold">
                      <%= vaga.empresa?.nome_empresa || vaga.empresa?.nome || 'Empresa' %>
                    </h5>

                    <div class="muted">
                      <%= [vaga.empresa?.cidade, vaga.empresa?.estado, vaga.empresa?.pais].filter(Boolean).join(', ') || 'Localidade n√£o informada' %>
                    </div>

                    <div class="fw-semibold mt-2"><%= vaga.cargo %></div>

                    <div class="d-flex flex-wrap gap-2 mt-2">
                      <span class="badge rounded-pill text-bg-light border">
                        <i class="bi bi-geo-alt me-1"></i>
                        <%= tipoMap[vaga.tipo_local_trabalho] %>
                      </span>

                      <% if (vaga.salario) { %>
                        <span class="badge rounded-pill text-bg-light border">
                          <i class="bi bi-cash-coin me-1"></i>
                          <%= Number(vaga.salario).toLocaleString('pt-BR', { style: 'currency', currency: vaga.moeda || 'BRL' }) %>
                        </span>
                      <% } %>
                    </div>

                    <% if (Array.isArray(vaga.vaga_area) && vaga.vaga_area.length) { %>
                      <div class="mt-2 d-flex flex-wrap gap-1">
                        <% vaga.vaga_area.forEach(function (rel) { %>
                          <span class="pill">
                            <%= (rel && rel.area_interesse && rel.area_interesse.nome)
                                  ? rel.area_interesse.nome
                                  : (rel?.nome || '') %>
                          </span>
                        <% }) %>
                      </div>
                    <% } %>
                  </div>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-3">
                  <a href="/candidatos/vagas/<%= vaga.id %>" class="btn btn-outline-primary">
                    <i class="bi bi-eye me-1"></i>
                    Ver detalhes
                  </a>
                </div>
              </div>
            <% }) %>
          <% } %>
        </div>
      </div>

      <!-- HIST√ìRICO RESUMIDO -->
      <div class="col-12 col-lg-5">
  <div class="bg-white rounded-2xl shadow-soft p-4 h-100">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="section-title">
        <i class="bi bi-clock-history me-1"></i>
        Hist√≥rico de candidaturas
      </div>

      <a href="/candidatos/vagas/historico" class="btn btn-sm btn-outline-secondary">
        Ver completo
      </a>
    </div>

    <% if (!historicoAplicacoes.length) { %>
      <div class="card-ghost p-4 rounded-2xl text-center">
        <div class="muted">Voc√™ ainda n√£o se candidatou a nenhuma vaga.</div>
      </div>
    <% } else { %>
      <div class="list-group list-group-flush">
        <% historicoAplicacoes.slice(0, 5).forEach(function (item) { 
             const vagaId = item?.vaga?.encId || item?.vaga?.encodedId || item?.vaga?.id; %>

          <a href="/candidatos/vagas/<%= vagaId %>"
             class="list-group-item list-group-item-action px-0 d-flex justify-content-between align-items-start"
             aria-label="Ver detalhes da vaga <%= item?.vaga?.cargo || '' %>">
            <div>
              <div class="fw-semibold">
                <%= item?.vaga?.cargo || 'Vaga' %> ‚Äî
                <span class="muted">
                  <%= (item?.empresa?.nome || item?.empresa?.nome_empresa || 'Empresa') %>
                </span>
              </div>

              <div class="small muted">
                <%= new Date(item?.aplicadoEm || item?.created_at || Date.now()).toLocaleString('pt-BR') %>
              </div>
            </div>

            <span class="badge rcounded-pill text-bg-light border">
              <%= formatStatus(item?.status) %>
            </span>
          </a>
        <% }) %>
      </div>
    <% } %>
  </div>
</div>

</main>

  <%- include('../partials/footer') %>
  
  <% if (!sessionRemember) { %>
<script>
  (function () {
    function sendBye() {
      try {
        const url = '/usuarios/_leave';
        const data = new Blob([], { type: 'application/octet-stream' });
        navigator.sendBeacon?.(url, data);
      } catch (e) { /* silencioso */ }
    }
    // Dispara em navega√ß√£o/fechamento (mais confi√°vel que beforeunload)
    window.addEventListener('pagehide', sendBye, { capture: true });
    // Safari antigos
    document.addEventListener('visibilitychange', function () {
      if (document.visibilityState === 'hidden') sendBye();
    });
  })();
</script>
<% } %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>  
  <script>
    document.querySelectorAll('.progress-bar[data-progress]').forEach(el => {
      const v = parseFloat(el.dataset.progress);
      if (!isNaN(v)) el.style.width = v + '%';
    });
  </script>
</body>
</html>
