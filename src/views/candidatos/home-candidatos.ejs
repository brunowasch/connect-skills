<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connect Skills</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/shared/style.css">
  <link rel="icon" type="image/png" href="/img/CONNECT.png?v=2">

  <style>
    :root { --header-h: 72px; }
    body { background:#f8f9fb; }
    main#content-main { margin-top: var(--header-h); }
    .card-ghost { border:1px dashed rgba(0,0,0,.15); background:#fff; }
    .rounded-2xl { border-radius: 1rem; }
    .shadow-soft { box-shadow: 0 6px 24px rgba(0,0,0,.06); }
    .pill { display:inline-block; padding:.25rem .6rem; border-radius:999px; background:#f1f3f5; font-size:.85rem; margin:.15rem .25rem .15rem 0; }
    .perfil-logo { width: 64px; height: 64px; object-fit: cover; }
    .card-vaga { border:1px solid rgba(0,0,0,.06); }
    .section-title { font-weight:700; font-size:1rem; letter-spacing:.2px; }
    .muted { color:#6c757d; }
    .grid-areas { display:flex; flex-wrap:wrap; gap:.4rem; }
    .kpi .num { font-weight:800; font-size:1.25rem; }
  </style>
</head>
<body>
  <%- include('../partials/header-candidato') %>
  <%- include('../partials/flash-messages') %>

  <main id="content-main" class="container py-4 py-md-5">
    <%
      const user = (typeof usuario !== 'undefined' && usuario) ? usuario : {};
      const cand = (typeof candidato !== 'undefined' && candidato) ? candidato : {};

      const nomeUser  = user?.nome || cand?.nome || 'Candidato';
      const sobrenome = user?.sobrenome || cand?.sobrenome || '';

      const localidadeResolved =
        (typeof candLocalidade !== 'undefined' && candLocalidade)
          ? candLocalidade
          : (
              (typeof localidade !== 'undefined' && localidade)
                ? localidade
                : 'Localidade n√£o informada'
            );

      const fotoPerfilResolved =
        (typeof candFotoPerfil !== 'undefined' && candFotoPerfil)
          ? candFotoPerfil
          : (
              (typeof fotoPerfil !== 'undefined' && fotoPerfil)
                ? fotoPerfil
                : ''
            );

      const fotoUrlCandidates = [
        cand?.foto_perfil,
        user?.foto_perfil,
        cand?.fotoPerfil,
        user?.fotoPerfil,
        fotoPerfilResolved || null
      ].filter(v => typeof v === 'string' && v.trim() !== '');

      const fotoUrl = (fotoUrlCandidates.length ? fotoUrlCandidates[0] : '/img/avatar.png');

      const _areas  = (typeof areas  !== 'undefined' && Array.isArray(areas))  ? areas  : (Array.isArray(cand?.areas) ? cand.areas : []);
      const _links  = (typeof links  !== 'undefined' && Array.isArray(links))  ? links  : [];
      const _anexos = (typeof anexos !== 'undefined' && Array.isArray(anexos)) ? anexos : [];

      const _historico =
        (typeof historico !== 'undefined' && Array.isArray(historico))
          ? historico
          : (
              (typeof historicoAplicado !== 'undefined' && Array.isArray(historicoAplicado))
                ? historicoAplicado
                : []
            );

      const _vagas = (typeof vagas !== 'undefined' && Array.isArray(vagas)) ? vagas : [];

      const areasSel          = _areas;
      const linksPerf         = _links;
      const anexosList        = _anexos;
      const historicoAplicacoes = _historico; // aplica√ß√µes (vaga_avaliacao)
      const vagasRecomendadas   = _vagas;     // vagas recomendadas

      // Telefone
      const hasDDD = (typeof ddd !== 'undefined') && String(ddd || '').trim() !== '';
      const hasNum = (typeof numeroFormatado !== 'undefined') && String(numeroFormatado || '').trim() !== '';
      const hasTel = (hasDDD && hasNum) || !!cand?.telefone;

      const hasNasc  = !!cand?.data_nascimento;
      const hasFoto  = (fotoUrl && fotoUrl !== '/img/avatar.png');
      const hasLocal = !!(localidadeResolved && localidadeResolved !== 'Localidade n√£o informada');
      const hasAreas = !!(areasSel && areasSel.length > 0);
      const hasLinks = !!(linksPerf && linksPerf.length > 0);
      const hasAnexo = !!(anexosList && anexosList.length > 0);

      const checklist    = [hasFoto, hasLocal, hasTel, hasNasc, hasAreas, hasLinks, hasAnexo];
      const totalSteps   = checklist.length;
      const doneSteps    = checklist.filter(Boolean).length;
      const profileCompletion = Math.max(0, Math.min(100, Math.round((doneSteps / totalSteps) * 100)));

      // Contagem segura de "vagas aplicadas"
      const aplicadasCount =
        (typeof candidaturasAplicadasCount !== 'undefined' && Number.isFinite(candidaturasAplicadasCount))
          ? Number(candidaturasAplicadasCount)
          : (Array.isArray(historicoAplicacoes) ? historicoAplicacoes.length : 0);

      function formatStatus(s) {
        if (!s) return '‚Äî';
        const map = {
          recebido: 'Recebido',
          visualizado: 'Visualizado',
          entrevista: 'Convidado para entrevista',
          recusado: 'Recusado',
          aprovado: 'Aprovado',
          em_analise: 'Em an√°lise'
        };
        return map[s] || s;
      }
    %>

    <!-- HERO -->
    <div class="bg-white rounded-2xl shadow-soft p-4 p-md-5 mb-4">
      <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
        <div class="d-flex align-items-center gap-3">
          <img
            src="<%= fotoUrl %>"
            class="rounded-circle border perfil-logo"
            alt="Foto do perfil"
          >
          <div>
            <div class="h4 m-0">Ol√°, <%= nomeUser %> <%= sobrenome %> üëã</div>
            <div class="small muted">
              <i class="bi bi-geo-alt me-1"></i> <%= localidadeResolved %>
            </div>
            <div class="muted">Bem-vindo ao seu painel do Connect Skills</div>
          </div>
        </div>

        <div class="d-flex flex-wrap justify-content-md-end gap-3 mt-3 mt-md-0">
          <a href="/candidato/editar-perfil" class="btn btn-outline-primary">
            <i class="bi bi-pencil-square me-1"></i>
            Editar perfil
          </a>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-4 mb-4">
      <div class="col-12 col-lg-4">
        <div class="bg-white rounded-2xl shadow-soft p-4 text-center h-100 dashboard-kpi">
          <i class="bi bi-search fs-3"></i>
          <div class="fw-bold fs-5"><%= vagasRecomendadas.length %></div>
          <div class="muted small">Vagas encontradas</div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="bg-white rounded-2xl shadow-soft p-4 text-center h-100 dashboard-kpi">
          <i class="bi bi-send-check fs-3"></i>
          <div class="fw-bold fs-5"><%= aplicadasCount %></div>
          <div class="muted small">Vagas aplicadas</div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="bg-white rounded-2xl shadow-soft p-4 h-100 dashboard-kpi">
          <div class="d-flex justify-content-between align-items-center mb-2 w-100">
            <div class="section-title">
              <i class="bi bi-diagram-3 me-1"></i>
              √Åreas de interesse
            </div>

            <a href="/candidato/editar-areas" class="text-decoration-none" title="Editar √°reas">
              <i class="bi bi-pencil-square"></i>
            </a>
          </div>

          <% if (!areasSel || !areasSel.length) { %>
            <div class="card-ghost p-4 rounded-2xl text-center w-100">
              <div class="muted">Voc√™ ainda n√£o selecionou √°reas.</div>
              <a class="btn btn-primary btn-sm mt-2" href="/candidato/editar-areas">
                Selecionar √°reas
              </a>
            </div>
          <% } else { %>
            <div class="grid-areas justify-content-center w-100">
              <% areasSel.slice(0, 6).forEach(function (a) { %>
                <span class="pill"><%= a %></span>
              <% }) %>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <div class="row g-4 mt-4">
      <!-- VAGAS RECOMENDADAS -->
      <div class="col-12 col-lg-7">
        <div class="bg-white rounded-2xl shadow-soft p-4 h-100">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="section-title">
              <i class="bi bi-stars me-1"></i>
              Vagas recomendadas
            </div>

            <a href="/candidatos/vagas" class="btn btn-sm btn-outline-primary">
              Ver todas
            </a>
          </div>

          <% if (!vagasRecomendadas.length) { %>
            <div class="card-ghost p-4 rounded-2xl text-center">
              <div class="muted">
                Ainda n√£o temos recomenda√ß√µes. Complete seu perfil e selecione √°reas para melhorar as sugest√µes.
              </div>
              <a class="btn btn-primary btn-sm mt-2" href="/candidato/editar-areas">
                Selecionar √°reas
              </a>
            </div>
          <% } else { %>
            <% const tipoMap = { Presencial: 'Presencial', Home_Office: 'Home Office', H_brido: 'H√≠brido' }; %>

            <% vagasRecomendadas.slice(0, 3).forEach(function (vaga) { %>
              <div class="card-vaga bg-white rounded-2xl p-3 p-md-4 mb-3">
                <div class="d-flex gap-3 align-items-start flex-wrap">
                  <a href="/empresa/perfil/<%= vaga.empresa?.id %>">
                    <img
                      src="<%= vaga.empresa?.foto_perfil || '/img/empresa-padrao.png' %>"
                      alt="Logo da empresa"
                      class="rounded-circle border perfil-logo"
                    >
                  </a>

                  <div class="flex-grow-1">
                    <h5 class="mb-0 fw-bold">
                      <%= vaga.empresa?.nome_empresa || vaga.empresa?.nome || 'Empresa' %>
                    </h5>

                    <div class="muted">
                      <%= [vaga.empresa?.cidade, vaga.empresa?.estado, vaga.empresa?.pais].filter(Boolean).join(', ') || 'Localidade n√£o informada' %>
                    </div>

                    <div class="fw-semibold mt-2"><%= vaga.cargo %></div>

                    <div class="d-flex flex-wrap gap-2 mt-2">
                      <span class="badge rounded-pill text-bg-light border">
                        <i class="bi bi-geo-alt me-1"></i>
                        <%= tipoMap[vaga.tipo_local_trabalho] %>
                      </span>

                      <% if (vaga.salario) { %>
                        <span class="badge rounded-pill text-bg-light border">
                          <i class="bi bi-cash-coin me-1"></i>
                          <%= Number(vaga.salario).toLocaleString('pt-BR', { style: 'currency', currency: vaga.moeda || 'BRL' }) %>
                        </span>
                      <% } %>
                    </div>

                    <% if (Array.isArray(vaga.vaga_area) && vaga.vaga_area.length) { %>
                      <div class="mt-2 d-flex flex-wrap gap-1">
                        <% vaga.vaga_area.forEach(function (rel) { %>
                          <span class="pill">
                            <%= (rel && rel.area_interesse && rel.area_interesse.nome)
                                  ? rel.area_interesse.nome
                                  : (rel?.nome || '') %>
                          </span>
                        <% }) %>
                      </div>
                    <% } %>
                  </div>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-3">
                  <a href="/candidatos/vagas/<%= vaga.id %>" class="btn btn-outline-primary">
                    <i class="bi bi-eye me-1"></i>
                    Ver detalhes
                  </a>
                </div>
              </div>
            <% }) %>
          <% } %>
        </div>
      </div>

      <!-- HIST√ìRICO RESUMIDO -->
      <div class="col-12 col-lg-5">
        <div class="bg-white rounded-2xl shadow-soft p-4 h-100">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="section-title">
              <i class="bi bi-clock-history me-1"></i>
              Hist√≥rico de candidaturas
            </div>

            <a href="/candidatos/vagas/historico" class="btn btn-sm btn-outline-secondary">
              Ver completo
            </a>
          </div>

          <% if (!historicoAplicacoes.length) { %>
            <div class="card-ghost p-4 rounded-2xl text-center">
              <div class="muted">Voc√™ ainda n√£o se candidatou a nenhuma vaga.</div>
            </div>
          <% } else { %>
            <div class="list-group list-group-flush">
              <% historicoAplicacoes.slice(0, 5).forEach(function (item) { %>
                <div class="list-group-item px-0 d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-semibold">
                      <%= item?.vaga?.cargo || 'Vaga' %> ‚Äî
                      <span class="muted">
                        <%= (item?.empresa?.nome || item?.empresa?.nome_empresa || 'Empresa') %>
                      </span>
                    </div>

                    <div class="small muted">
                      <%= new Date(item?.aplicadoEm || item?.created_at || Date.now()).toLocaleString('pt-BR') %>
                    </div>
                  </div>

                  <span class="badge rounded-pill text-bg-light border">
                    <%= formatStatus(item?.status) %>
                  </span>
                </div>
              <% }) %>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </main>

  <%- include('../partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
