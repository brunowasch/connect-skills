<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connect Skills</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="icon" type="image/png" href="/img/CONNECT.png?v=2">
  <link rel="stylesheet" href="/css/shared/style.css"> 
    <%
    const tipoMap = {
      Presencial:   'Presencial',
      Home_Office:  'Home Office',
      H_brido:      'Híbrido'
    };
  %>
  <style>
    :root { --nav-h: 0px !important; }
    body#home { padding-top: 0 !important; }
    main#content-main { margin-top: var(--header-h); }
    .badge-chip { font-weight: 500; }
    .pill { display:inline-block; padding:.25rem .6rem; border-radius: 999px; background:#f1f3f5; font-size:.85rem; margin:.15rem .25rem .15rem 0; }
    .section-title { font-size:1.05rem; font-weight:600; margin-bottom:.5rem; }
    .meta { color:#6c757d; font-size:.95rem; }
    .card-shadow { box-shadow: 0 4px 16px rgba(0,0,0,.06); border: 1px solid #eee; }
    .salary { font-size:1.15rem; font-weight:700; }
    .sticky-actions { position: sticky; bottom: 0; background: #fff; padding: 12px; border-top: 1px solid #e9ecef; display: flex; gap: 8px; justify-content: flex-end; }
    @media (max-width: 576px) { .sticky-actions { position: static; } }
    .bloco-ia { display: none; }
    #modalConfirmarRemocao .modal-content {
    border-radius: 15px;
    }
    #modalConfirmarRemocao .modal-header {
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
        background: linear-gradient(135deg, #dc3545 0%, #a71d2a 100%); /* Degradê vermelho para alerta */
    }
  </style>
</head>
<body class="bg-light">
<%- include('../partials/header-candidato') %>
  <% const somentePreview = !(typeof podeTestar !== 'undefined' && podeTestar); %>
  <% if (somentePreview) { %>
    <div class="alert alert-warning text-center preview-badge mb-0">
      <i class="bi bi-eye"></i> Pré-visualização — entre como <strong>candidato</strong> para responder o questionário e ver sua compatibilidade.
      <a href="/login" class="alert-link ms-1">Fazer login</a>
    </div>
  <% } %>
  <main class="container my-4 main-ajustado-header">
    <div class="mb-2">
      <a href="javascript:history.back()" class="text-decoration-none">
        <i class="bi bi-arrow-left"></i> Voltar
      </a>
    </div>

    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/candidatos/vagas">Vagas</a></li>
        <li class="breadcrumb-item active" aria-current="page"><%= vaga.cargo || 'Vaga' %></li>
      </ol>
    </nav>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card card-shadow p-3 p-md-4">
          <div class="d-flex align-items-start justify-content-between gap-3">
            <div>
              <h1 class="h4 mb-1 d-flex align-items-center gap-2">
                <span><%= vaga.cargo %></span>
                <% if (typeof jaAplicou !== 'undefined' && jaAplicou) { %>
                  <span class="badge rounded-pill text-bg-secondary">Já aplicada</span>
                <% } %>
              </h1>
              <div class="meta">
                <i class="bi bi-building"></i>
                <%= vaga.empresa?.nome || vaga.empresa?.usuario?.nome || 'Empresa' %>
                <span class="mx-2">•</span>
                <i class="bi bi-calendar3"></i> Publicado em <%= publicadoEmBR %>
              </div>
            </div>
            <span class="badge text-bg-secondary badge-chip"><%= tipoMap[vaga.tipo_local_trabalho] %></span>
          </div>

          <hr/>

          <div class="row g-3">
            <div class="col-12 col-md-6">
              <div class="section-title"><i class="bi bi-cash-coin"></i> Salário</div>
              <div class="salary"><%= vaga.salario ? `R$ ${Number(vaga.salario).toLocaleString('pt-BR', { minimumFractionDigits:2 })}` : 'A combinar' %></div>
            </div>
            <div class="col-12 col-md-6">
              <div class="section-title"><i class="bi bi-clock-history"></i> Escala</div>
              <div><%= vaga.escala_trabalho || '—' %></div>
            </div>
            <% if (typeof diasPresenciais !== 'undefined' && diasPresenciais) { %>
            <div class="col-12 col-md-6">
              <div class="section-title"><i class="bi bi-building-check"></i> Dias presenciais</div>
              <div><%= diasPresenciais %></div>
            </div>
            <% } %>
            <% if (diasHomeOffice) { %>
            <div class="col-12 col-md-6">
              <div class="section-title"><i class="bi bi-house"></i> Dias Home Office</div>
              <div><%= diasHomeOffice %></div>
            </div>
            <% } %>
          </div>
          
          <div class="col-12 col-md-6">
            <div class="section-title"><i class="bi bi-briefcase"></i> Vínculo empregatício</div>
            <% const vinculoMap = {
                Estagio: 'Estágio',
                CLT_Tempo_Integral: 'CLT (tempo integral)',
                CLT_Meio_Periodo: 'CLT (meio período)',
                Trainee: 'Trainee',
                Aprendiz: 'Aprendiz',
                PJ: 'PJ (Pessoa Jurídica)',
                Freelancer_Autonomo: 'Freelancer / Autônomo',
                Temporario: 'Temporário'
              }; %>
            <div><%= vinculoMap[vaga.vinculo_empregaticio] || '—' %></div>
          </div>

          <hr/>

          <div class="mb-3">
            <div class="section-title"><i class="bi bi-card-text"></i> Descrição</div>
            <p class="mb-0" style="white-space:pre-wrap"><%= vaga.descricao || 'Sem descrição informada.' %></p>
          </div>

          <% if (beneficios && beneficios.length) { %>
          <div class="mb-3">
            <div class="section-title"><i class="bi bi-gift"></i> Benefícios</div>
            <div>
              <% beneficios.forEach(b => { %>
                <span class="pill"><%= b %></span>
              <% }) %>
            </div>
          </div>
          <% } %>

          <% if (vaga.vaga_arquivo?.length) { %>
            <div class="mb-3">
              <div class="section-title"><i class="bi bi-paperclip"></i> Anexos</div>
              <ul class="list-unstyled mb-0">
                <% vaga.vaga_arquivo.forEach(ax => { %>
                  <li class="mb-2">
                    <a href="/candidatos/vagas/anexo/<%= encodeId(ax.id) %>" target="_blank" rel="noopener">
                      <i class="bi bi-file-earmark-text me-1"></i> <%= ax.nome %>
                    </a>
                  </li>
                <% }) %>
              </ul>
            </div>
          <% } %>
          
          <% if (vaga.vaga_link?.length) { %>
            <div class="mb-3">
              <div class="section-title"><i class="bi bi-link-45deg"></i> Links</div>
              <ul class="list-unstyled mb-0">
                <% vaga.vaga_link.forEach(lk => { %>
                  <li class="mb-2">
                    <a href="<%= lk.url %>" target="_blank" rel="noopener"><%= lk.titulo %></a>
                  </li>
                <% }) %>
              </ul>
            </div>
          <% } %>

          <% if (areas && areas.length) { %>
          <div class="mb-3">
            <div class="section-title"><i class="bi bi-diagram-3"></i> Áreas de atuação</div>
            <div>
              <% areas.forEach(a => { %>
                <span class="pill"><%= a %></span>
              <% }) %>
            </div>
          </div>
          <% } %>

        <% if (typeof jaAplicou !== 'undefined' && jaAplicou) { %>
            <div class="alert alert-info d-flex align-items-center justify-content-between mb-3">
              <span><i class="bi bi-info-circle me-2"></i>Você já se candidatou a esta vaga.</span>
              <a href="/candidatos/vagas/historico" class="btn btn-outline-primary btn-sm">Ver histórico</a>
            </div>
            
            <% 
              const videoUrl = (avaliacao && avaliacao.resposta && avaliacao.resposta.includes('cloudinary')) ? avaliacao.resposta : null;
            %>

            <% if (videoUrl) { %>
              <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4" style="border: 2px solid #6a11cb; border-radius: 15px;">
                  <h5 class="card-title text-primary fw-bold mb-3">
                    <i class="bi bi-camera-video me-2"></i>Seu Vídeo de Apresentação
                  </h5>

                  <div class="row">
                    <div class="col-md-7">
                      <div class="ratio ratio-16x9 rounded overflow-hidden shadow-sm bg-black">
                        <video controls>
                          <source src="<%= videoUrl %>" type="video/mp4">
                          Seu navegador não suporta a tag de vídeo.
                        </video>
                      </div>
                    </div>
                    <div class="col-md-5 d-flex flex-column justify-content-center mt-3 mt-md-0">
                        <h6 class="fw-bold">Alterar apresentação</h6>
                        <p class="text-muted small">
                          Deseja enviar um vídeo diferente? Remova o atual primeiro.
                        </p>
                        
                        <button type="button" class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#modalConfirmarRemocao">
                          <i class="bi bi-trash me-2"></i>Remover Vídeo
                        </button>
                    </div>
                  </div>
                </div>
              </div>
            <% } else { %>
              <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                  <h5 class="card-title text-primary fw-bold mb-3">Enviar Vídeo de Apresentação</h5>
                  <form action="/candidatos/vagas/upload-video" method="POST" enctype="multipart/form-data" id="formVideo">
                    <input type="hidden" name="vagaId" value="<%= vaga.id %>">
                    <div class="input-group">
                      <input type="file" class="form-control" name="video" accept="video/*" required>
                      <button class="btn btn-primary" type="submit">Enviar</button>
                    </div>
                  </form>
                </div>
              </div>
            <% } %>
            <button class="btn btn-secondary" type="button" disabled title="Você já aplicou a esta vaga">
              <i class="bi bi-robot"></i> Iniciar entrevista com IA
            </button>
        <% } else { %>
            <% if (somentePreview) { %>
              <!-- Visitante / não logado como candidato: botão cinza e sem questionário -->
              <button class="btn btn-secondary" type="button" disabled
                title="Faça login como candidato para iniciar a entrevista">
                <i class="bi bi-robot"></i>  Iniciar entrevista com 
              </button>
              <small class="mt-2 text-center">Faça login como candidato para iniciar a entrevista</small>
            <% } else { %>
              <!-- Candidato logado: botão ativo + bloco de perguntas -->
              <button class="btn btn-primary btn-entrevista" type="button" id="btn-abrir-ia">
                <i class="bi bi-robot"></i>  Iniciar entrevista com IA
              </button>

              <div id="bloco-ia" class="bloco-ia border rounded p-3 bg-light mt-3">
                <h6 class="fw-semibold mb-3">Questionário da vaga</h6>
                  <% const perguntas = Array.isArray(perguntasLista) && perguntasLista.length ? perguntasLista
                  : (vaga.pergunta || '').split('\n') .map(s => s.trim()) .filter(Boolean);
                  %>
                <% if (perguntas.length) { %>
                  <% perguntas.forEach((q, idx) => { %>
                    <div class="mb-3">
                      <label class="form-label"><%= (idx+1) + '. ' + q %></label>
                      <textarea class="form-control resposta-ia-item" rows="3" placeholder="Digite sua resposta..."></textarea>
                    </div>
                  <% }) %>
                <% } else { %>
                  <textarea class="form-control resposta-ia" rows="3" placeholder="Digite sua resposta..."></textarea>
                <% } %>
                <div class="d-flex gap-2 mt-3">
                  <button id="btn-analisar" class="btn btn-success" type="button">
                    <i class="bi bi-send me-1"></i> Enviar respostas
                  </button>
                  <button id="btn-fechar-ia" class="btn btn-outline-secondary" type="button">Ocultar</button>
                </div>
                <div id="resultados-ia" class="mt-3"></div>
              </div>
            <% } %>
          <% } %>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card card-shadow p-3 p-md-4">
          <div class="d-flex align-items-center gap-3">
          <%
            function empresaLogo(e) {
              const s = String(e?.foto_perfil || '').trim();
              if (!s || s === 'null' || s === 'undefined') return '/img/placeholder-empresa.png';
              return s;
            }
          %>
          <img
            src="<%= empresaLogo(vaga.empresa) %>"
            alt="Foto da Empresa"
            class="rounded-circle border"
            style="width:56px;height:56px;object-fit:cover;"
            onerror="this.onerror=null;this.src='/img/placeholder-empresa.png';">
            <div>
              <div class="fw-semibold mb-1"><%= vaga.empresa?.nome_empresa || vaga.empresa?.nome || 'Empresa' %></div>
              <%
                const partes = [vaga.empresa?.cidade, vaga.empresa?.estado, vaga.empresa?.pais].filter(Boolean);
                const loc = partes.join(', ');
              %>
              <div class="meta"><%= loc || 'Localidade não informada' %></div>
              <% if (vaga.empresa?.descricao) { %>
                <div class="small text-muted mt-1"><%= vaga.empresa.descricao.length > 120 ? vaga.empresa.descricao.slice(0,120) + '…' : vaga.empresa.descricao %></div>
              <% } %>
            </div>
          </div>

          <hr/>

          <div class="d-grid gap-2">
            <a href="/empresa/perfil/<%= encEmpresaId %>" class="btn btn-outline-primary">
              <i class="bi bi-box-arrow-up-right"></i> Ver perfil público
            </a>
            <% if (vaga.empresa?.usuario?.email) { %>
              <div class="small text-muted text-center">
                Contato: <%= vaga.empresa.usuario.email %>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
    <div id="vaga-dados"
         data-vaga-id="<%= vaga.id %>"
         data-items="<%- encodeURIComponent(vaga.descricao || '') %>"
         data-skills="<%- encodeURIComponent(JSON.stringify(skills || [])) %>"></div>
  </main>

  <div class="modal fade" id="modalConfirmarRemocao" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Remover Vídeo</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center py-4">
        <div class="mb-3">
          <i class="bi bi-trash text-danger" style="font-size: 3rem;"></i>
        </div>
        <p class="mb-1">Você tem certeza que deseja remover sua apresentação?</p>
        <p class="text-muted small px-3">
          Ao remover, a empresa não poderá mais assistir seu vídeo no ranking até que você envie um novo.
        </p>
      </div>
      <div class="modal-footer border-0 justify-content-center pb-4">
        <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancelar</button>
        <form action="/candidatos/vagas/<%= vaga.id %>/remover-video" method="POST" id="formRemoverVideo">
          <button type="submit" class="btn btn-danger px-4 fw-bold">
            Sim, remover vídeo
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

  <%- include('../partials/footer') %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
      document.getElementById('formVideo')?.addEventListener('submit', function() {
          Swal.fire({
              title: 'Enviando vídeo...',
              html: 'Aguarde enquanto processamos seu arquivo.',
              allowOutsideClick: false,
              didOpen: () => {
                  Swal.showLoading();
              }
          });
      });
  </script>
  <script>
    (function(){
      const bloco = document.getElementById('bloco-ia');
      const btnAbrir = document.getElementById('btn-abrir-ia');
      const btnFechar = document.getElementById('btn-fechar-ia');
      const btnAnalisar = document.getElementById('btn-analisar');
      const resultados = document.getElementById('resultados-ia');

      const dadosEl = document.getElementById('vaga-dados');
      const vagaId = Number(dadosEl?.dataset.vagaId || 0);
      const items = decodeURIComponent(dadosEl?.dataset.items || '');
      const skills = JSON.parse(decodeURIComponent(dadosEl?.dataset.skills || '[]'));

      function openIA() {
        if (bloco) {
          bloco.style.display = 'block';
          bloco.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }
      function closeIA() {
        if (bloco) bloco.style.display = 'none';
      }

      btnAbrir && btnAbrir.addEventListener('click', openIA);
      btnFechar && btnFechar.addEventListener('click', closeIA);

      btnAnalisar && btnAnalisar.addEventListener('click', async () => {
        if (!resultados) return;
        resultados.innerHTML = '<div class="text-muted">Analisando...</div>';

        const qa = [];
        document.querySelectorAll('.resposta-ia-item').forEach((textarea) => {
          const labelEl = textarea.closest('.mb-3, .mb-2')?.querySelector('.form-label');
          const label = labelEl ? labelEl.textContent : '';
          qa.push({ question: label.replace(/^\d+\.\s*/, ''), answer: textarea.value });
        });
        if (!qa.length) {
          const unica = document.querySelector('.resposta-ia')?.value || '';
          if (unica.trim()) qa.push({ question: 'Resposta', answer: unica.trim() });
        }

        try {
          const resp = await fetch(`/candidatos/vagas/${vagaId}/avaliar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ qa, items, skills })
          });

          let data;
          try { data = await resp.json(); }
          catch { data = { ok: false, error: `Resposta inesperada (${resp.status})` }; }

          if (!resp.ok || !data.ok) {
            const msg = (data && (data.error || data.erro)) || `Erro ${resp.status}`;
            throw new Error(msg);
          }

          const linhas = (data.results || []).map(r => {
            const item = r.Item || r.item || r.titulo || 'Critério';
            const nota = (typeof r.rating === 'number') ? r.rating : (r.score ?? '');
            return `<li><strong>${item}:</strong> ${nota}</li>`;
          }).join('');

          resultados.innerHTML = `
            <div class="alert alert-success">
              <div class="alert alert-success">Suas respostas foram enviadas com sucesso!</div>
              <ul class="mb-0">${linhas}</ul>
            </div>`;
        } catch (err) {
          resultados.innerHTML = `<div class="alert alert-warning">Não foi possível analisar agora. ${err.message || ''}</div>`;
        }
      });
    })();
  </script>
  <script>
    document.getElementById('formRemoverVideo')?.addEventListener('submit', function() {
    const btn = this.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Removendo...';
    });
  </script>
</body>
</html>
